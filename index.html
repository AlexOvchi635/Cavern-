<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Cavern</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 500px;
            max-height: 800px;
            min-height: 600px;
            background: #000;
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #87CEEB 0%, #98D8E8 50%, #B0E0E6 100%);
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #score {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 15;
            display: none;
            transition: transform 0.5s ease-in-out; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç */
        }

        #scoreImage {
            width: auto;
            height: 40px;
            max-width: 150px;
            display: block;
        }

        #scoreText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 
                1px 1px 2px rgba(0, 0, 0, 0.8),
                0 0 4px rgba(0, 0, 0, 0.5);
            font-family: 'Arial', sans-serif;
            pointer-events: none;
            white-space: nowrap;
        }

        #highScore {
            display: none;
        }

        #startScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            z-index: 20;
            pointer-events: auto;
            background: transparent;
            padding: 0;
            border-radius: 0;
            border: none;
            box-shadow: none;
        }

        #startScreen h1 {
            display: none;
        }

        #startScreen p {
            display: none;
        }

        #flagImage {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 1400px;
            height: auto;
            z-index: 20;
            display: block;
        }

        #startBtn {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            margin: 0;
            padding: 0;
            background: none;
            border: none;
            cursor: pointer;
            pointer-events: auto;
            display: block;
            z-index: 21;
        }
        
        #startBtn img {
            display: block;
            width: 500px;
            height: auto;
            max-width: 80vw;
        }
        
        #heroOnButton {
            position: absolute;
            bottom: calc(20% + 209px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 22;
            pointer-events: none;
            animation: heroJump 1s ease-out infinite;
        }
        
        #heroOnButton img {
            width: 80px;
            height: auto;
            display: block;
        }
        
        @keyframes heroJump {
            0% {
                transform: translateX(-50%) translateY(0);
                animation-timing-function: ease-out;
            }
            50% {
                transform: translateX(-50%) translateY(-90px);
                animation-timing-function: ease-in;
            }
            100% {
                transform: translateX(-50%) translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }
        }


        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 20;
            pointer-events: auto;
            display: none;
        }

        #gameOverTitle {
            font-size: 36px;
            margin-bottom: -100px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            font-weight: bold;
            font-family: 'Press Start 2P', cursive;
            position: relative;
            top: -80px;
            cursor: pointer;
            pointer-events: auto;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        #gameOverTitle:hover {
            opacity: 0.8;
        }

        #gameOverTitle:active {
            opacity: 0.6;
        }

        #finalScoreContainer {
            position: relative;
            display: inline-block;
            margin-bottom: -60px;
            transform: translateY(60px);
        }

        #finalScoreImage {
            width: auto;
            height: 60px;
            max-width: 200px;
            display: block;
        }

        #finalScore {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 
                1px 1px 2px rgba(0, 0, 0, 0.8),
                0 0 4px rgba(0, 0, 0, 0.5);
            font-family: 'Arial', sans-serif;
            pointer-events: none;
            white-space: nowrap;
        }


        .hidden {
            display: none !important;
        }

        #controls {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 150px;
            z-index: 15;
            pointer-events: auto;
        }

        .controlBtn {
            width: 84px;
            height: 84px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            backdrop-filter: none;
            transition: all 0.1s;
            position: relative;
            overflow: visible;
        }

        .controlBtn img {
            width: 130%;
            height: 130%;
            object-fit: cover;
            pointer-events: none;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .controlBtn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 500px) {
            #gameContainer {
                max-width: 100%;
                max-height: 100%;
                width: 100vw;
                height: 100vh;
            }
            
            #startScreen h1 {
                font-size: 36px;
            }
            
            #score {
                top: 8px;
                right: 8px;
            }

            #scoreImage {
                height: 30px;
                max-width: 120px;
            }

            #scoreText {
                font-size: 14px;
            }

            #gameOverTitle {
                font-size: 28px;
                margin-bottom: 20px;
            }

            #finalScoreImage {
                height: 45px;
                max-width: 150px;
            }

            #finalScore {
                font-size: 18px;
            }

            
            #highScore {
                font-size: 18px;
            }
            
            /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ Telegram */
            #flagImage {
                top: 2vh;
                transform: translateX(-50%);
                width: 100vw;
                max-width: none;
                margin-top: 0;
                display: block;
            }
            
            #startBtn {
                bottom: 5vh;
                top: auto;
                margin-top: 0;
                transform: translateX(-50%);
            }
            
            #startBtn img {
                width: 95vw;
                max-width: none;
            }
            
            #heroOnButton {
                bottom: calc(5vh + 95vw * 0.29);
                left: 50%;
                transform: translateX(-50%);
                display: block;
                animation: heroJump 1s ease-out infinite;
            }
            
            #heroOnButton img {
                width: 80px;
            }
        }
        
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Telegram Mini App (–º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã) */
        @media (max-height: 800px) and (max-width: 500px) {
            #flagImage {
                top: 1vh;
                transform: translateX(-50%);
                width: 100vw;
                max-width: none;
            }
            
            #startBtn {
                bottom: 4vh;
            }
            
            #startBtn img {
                width: 95vw;
                max-width: none;
            }
            
            #heroOnButton {
                bottom: calc(4vh + 95vw * 0.29);
                left: 50%;
                transform: translateX(-50%);
                display: block;
                animation: heroJump 1s ease-out infinite;
            }
            
            #heroOnButton img {
                width: 70px;
            }
        }

        /* CSS –§–æ–Ω–∞—Ä—å */
        #cssLantern {
            position: absolute;
            display: none;
            pointer-events: none;
            z-index: 15;
            transform: scale(0.15) translate(-50%, -50%);
            transform-origin: top left;
        }

        .lantern-scene {
            width: 200px;
            height: 250px;
            position: relative;
        }

        .lantern {
            --c-lantern-body: hsl(262,38%,20%);
            --c-lantern-light: hsl(23,98%,75%);
            --c-lantern-glow: hsl(343,83%,63%);

            display: flex;
            flex-direction: column;
            left: calc(50%);
            position: absolute;
            transform: translateX(-50%);
        }
        .lantern-handle {
            border: 6px solid hsl(257,41%,27%);
            border-radius: 50px;
            height: 105px;
            width: 200px;
        }
        .lantern-inner {
            animation: lantern-anim 1.2s ease-in-out alternate infinite;
            margin-top: -5px;
            transform-origin: top center;
        }
        .lantern-chain {
            height: 60px;
        }
        .lantern-chain::before {
            --c: hsl(260,38%,34%);
            background-color: var(--c);
            box-shadow:
                    0 0 0 5px var(--c),
                    0 20px 0 var(--c),
                    0 35px 0 var(--c),
                    0 50px 0 var(--c);
            border-radius: 50%;
            content: '';
            display: block;
            height: 10px;
            margin: 0 auto;
            width: 10px;
        }

        .lantern-head::before,
        .lantern-head::after {
            background: var(--c-lantern-body);
            border-radius: 5px;
            content: '';
            display: block;
            height: 15px;
        }
        .lantern-head::before {
            margin: 0 auto;
            width: 100px;
        }
        .lantern-head::after {
            border-radius: 3px;
            height: 30px;
            margin: 3px auto;
            width: 60px;
        }

        .lantern-body {
            perspective: 350px;
            position: relative;
        }
        .lantern-body::before {
            background-color: var(--c-lantern-light);
            border: 8px solid var(--c-lantern-body);
            border-radius: 50px;
            box-shadow:
                    inset 0 0 0 5px var(--c-lantern-light),
                    inset 0 0 0 20px var(--c-lantern-glow);
            content: '';
            display: block;
            height: 195px;
            margin: 0 auto;
            perspective: 100px;
            transform: rotateX(20deg) translateY(-20px);
            transform-origin: center center;
            width: 120px;
        }
        .lantern-body::after {
            --c: hsl(321,41%,42%);
            background-color: var(--c);
            border-radius: 4px;
            box-shadow: -5px 161px 0 1px var(--c), 5px 161px 0 1px var(--c);
            content: '';
            display: block;
            height: 7px;
            margin: -7px auto 0;
            transform: translateY(-195px);
            width: 40px;
        }

        .lantern-spark {
            animation: lantern-spark-anim linear 2s forwards infinite;
            background:
                    radial-gradient(circle at center, var(--c-lantern-light) 60%, transparent 60%),
                    linear-gradient(to right, transparent 10%, #fff 50%, transparent 50%);
            border-radius: 50%;
            clip: rect(0px 30px 30px 0px);
            height: 60px;
            left: calc(50% - 30px);
            position: absolute;
            top: calc(45% - 30px);
            transform-origin: center center;
            width: 60px;
        }
        .lantern-spark:nth-child(2) {
            animation-delay: calc(2s / 3);
        }
        .lantern-spark:nth-child(3) {
            animation-delay: calc((2s / 3) * 2);
        }

        .lantern-flame {
            background-color: #fff;
            border-radius: 50%;
            height: 30px;
            left: calc(50% - 15px);
            position: absolute;
            top: calc(45% - 15px);
            width: 30px;
        }

        .lantern-base {
            background: var(--c-lantern-body);
            border-radius: 5px;
            display: block;
            height: 15px;
            margin: -15px auto 0;
            width: 70px;
        }

        @keyframes lantern-anim {
            0% {
                transform: rotateZ(1deg);
            }
            100% {
                transform: rotateZ(-1deg);
            }
        }
        @keyframes lantern-spark-anim {
            100% {
                transform: rotateZ(360deg);
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
    <div id="ui">
            <div id="score">
                <img id="scoreImage" src="https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeiheenqd6cs75o5bmf7rgxeoat6hojd7d5ncxi57dqz5gs3kenjfxe" alt="Score">
                <span id="scoreText">0</span>
            </div>
            <div id="highScore">–†–µ–∫–æ—Ä–¥: 0</div>
            <div id="controls">
                <div class="controlBtn" id="leftBtn">
                    <img src="https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeifugsuqinrxkfkgzccckpnmuppp33zvl5blydhynjf6qgxt3n73si" alt="–í–ª–µ–≤–æ">
                </div>
                <div class="controlBtn" id="rightBtn">
                    <img src="https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeihexo7w6x4nr4nb57gard3mtz6wpq7ujwrwgldwdjc76rwkenaclu" alt="–í–ø—Ä–∞–≤–æ">
                </div>
            </div>
        </div>
        <img id="flagImage" src="https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeia3jddld5twkyc2732263ghj7vwnbea7axpyhbsaxgaufz7oppism" alt="–§–ª–∞–≥">
        <button id="startBtn">
            <img src="https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafkreifubhfsu2mte54zfod244cz4smwk4yqlnf6lphwtfqatqyeal2wwe" alt="–ù–∞—á–∞—Ç—å –∏–≥—Ä—É">
        </button>
        <div id="heroOnButton">
            <img src="https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeie5cezd2vxdqdnqynqstkh5tjmenuruoc3pg2i65hx2gsxenojy7y" alt="–ì–µ—Ä–æ–π">
        </div>
        <div id="startScreen">
            <h1>Cavern</h1>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–µ–ª–∫–∏ –∏–ª–∏ –∫–Ω–æ–ø–∫–∏<br>–¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
            <p>–ü—Ä—ã–≥–∞–π—Ç–µ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã<br>–∏ –ø–æ–¥–Ω–∏–º–∞–π—Ç–µ—Å—å –≤—ã—à–µ!</p>
    </div>
    <div id="gameOver">
        <h2 id="gameOverTitle">Game Over</h2>
        <div id="finalScoreContainer">
            <img id="finalScoreImage" src="https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeiheenqd6cs75o5bmf7rgxeoat6hojd7d5ncxi57dqz5gs3kenjfxe" alt="Score">
            <span id="finalScore">0</span>
    </div>
    </div>
    
    <!-- CSS –§–æ–Ω–∞—Ä—å -->
    <div id="cssLantern">
        <div class="lantern-scene">
            <div class="lantern">
                <div class="lantern-handle"></div>
                <div class="lantern-inner">
                    <div class="lantern-chain"></div>
                    <div class="lantern-head"></div>
                    <div class="lantern-body">
                        <span class="lantern-spark"></span>
                        <span class="lantern-spark"></span>
                        <span class="lantern-spark"></span>
                        <span class="lantern-flame"></span>
                    </div>
                    <div class="lantern-base"></div>
                </div>
            </div>
        </div>
    </div>
    
    </div>

    <script>
        // Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const scoreTextEl = document.getElementById('scoreText');
        const highScoreEl = document.getElementById('highScore');
        const gameOverEl = document.getElementById('gameOver');
        const finalScoreEl = document.getElementById('finalScore');
        const startScreen = document.getElementById('startScreen');
        const startBtn = document.getElementById('startBtn');
        const gameOverTitle = document.getElementById('gameOverTitle');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
        function resizeCanvas() {
            const container = document.getElementById('gameContainer');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let gameState = 'start'; // start, playing, gameOver
        let highScore = 0;
        let score = 0;
        let cameraY = 0;
        let highestPlayerY = 0; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –ø–æ–¥–Ω—è–ª—Å—è –∏–≥—Ä–æ–∫ (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ player.y)
        
        // –°–ø—Ä–∞–π—Ç –æ–≥–Ω—è –æ—Ç —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞–Ω—Ü–∞
        
        // –§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const backgroundImage = new Image();
        backgroundImage.src = 'https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeifwinisuha2cu7hwmmfa7wyt5nl2ullhmwnvv4q5swdv7s6krmt7y';
        let backgroundLoaded = false;
        backgroundImage.onload = () => {
            backgroundLoaded = true;
        };

        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        const playerImageLeft = new Image(); // –ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–º–æ—Ç—Ä–∏—Ç –≤–ª–µ–≤–æ
        playerImageLeft.src = 'https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeibs3byjdd3tmqt4fod5ll6x7om3qqjgtsoicgayqr2g2e4qftez7a';
        let playerImageLeftLoaded = false;
        playerImageLeft.onload = () => {
            playerImageLeftLoaded = true;
            updatePlayerSize();
        };

        const playerImageRight = new Image(); // –ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–º–æ—Ç—Ä–∏—Ç –≤–ø—Ä–∞–≤–æ
        playerImageRight.src = 'https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeie5cezd2vxdqdnqynqstkh5tjmenuruoc3pg2i65hx2gsxenojy7y';
        let playerImageRightLoaded = false;
        playerImageRight.onload = () => {
            playerImageRightLoaded = true;
            updatePlayerSize();
        };

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        function updatePlayerSize() {
            if (playerImageLeftLoaded || playerImageRightLoaded) {
                const img = playerImageLeftLoaded ? playerImageLeft : playerImageRight;
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                const maxWidth = 60; // –ë—ã–ª–æ 50
                const maxHeight = 70; // –ë—ã–ª–æ 60
                const scale = Math.min(maxWidth / img.width, maxHeight / img.height);
                player.width = img.width * scale;
                player.height = img.height * scale;
            }
        }

        // –°–ø—Ä–∞–π—Ç—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º
        const platformImage = new Image(); // –û–±—ã—á–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
        let platformImageLoaded = false;
        platformImage.onload = () => {
            platformImageLoaded = true;
            console.log('–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', platformImage.width, 'x', platformImage.height);
        };
        platformImage.onerror = (e) => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã:', e);
            platformImageLoaded = false;
        };
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        platformImage.src = 'https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeignsx6nwrqdfykr5tkqcmbsqkve42uz5mvgmrrrtu46gf7vrqbxbm';

        const movingPlatformImage = new Image(); // –î–≤–∏–∂—É—â–∞—è—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å–ø—Ä–∞–π—Ç)
        let movingPlatformImageLoaded = false;
        movingPlatformImage.onload = () => {
            movingPlatformImageLoaded = true;
        };
        movingPlatformImage.onerror = (e) => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–≤–∏–∂—É—â–µ–π—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã:', e);
            movingPlatformImageLoaded = false;
        };
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å–ø—Ä–∞–π—Ç —á—Ç–æ –∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
        movingPlatformImage.src = 'https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeignsx6nwrqdfykr5tkqcmbsqkve42uz5mvgmrrrtu46gf7vrqbxbm';

        // –ò–≥—Ä–æ–∫
        const player = {
            x: 0,
            y: 0,
            width: 40,
            height: 50,
            velocityX: 0,
            velocityY: 0,
            onPlatform: false,
            hasJetpack: false,
            jetpackStartTime: 0, // –í—Ä–µ–º—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–∞–Ω—Ü–∞ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
            jetpackDuration: 1500, // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–µ—Ç–∞ (–º—Å), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1500
            immunityEndTime: 0, // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
            monstersHiddenUntil: 0, // –í—Ä–µ–º—è –¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –º–æ–Ω—Å—Ç—Ä—ã —Å–∫—Ä—ã—Ç—ã
            jetpacksHiddenUntil: 0, // –í—Ä–µ–º—è –¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ —Ä–∞–Ω—Ü—ã —Å–∫—Ä—ã—Ç—ã
            hasLantern: false, // –ï—Å—Ç—å –ª–∏ —Ñ–æ–Ω–∞—Ä—å
            lightRadius: 0, // –†–∞–¥–∏—É—Å –æ—Å–≤–µ—â–µ–Ω–∏—è
            isInverted: false, // –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç –ª–∏ –∏–≥—Ä–æ–∫ (–≤–∏—Å–∏—Ç –Ω–∞ –ø–æ—Ç–æ–ª–∫–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º)
            isFlipping: false, // –ò–¥–µ—Ç –ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞
            flipStartTime: 0 // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞
        };

        // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
        let platforms = [];
        const PLATFORM_WIDTH = 90; // –£–º–µ–Ω—å—à–µ–Ω–æ —Å 120 –¥–æ 90
        const PLATFORM_HEIGHT = 25; // –£–º–µ–Ω—å—à–µ–Ω–æ —Å 30 –¥–æ 25
        const PLATFORM_SPACING = 70;
        
        // –°–∏—Å—Ç–µ–º–∞ —Å–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º
        const SECTOR_HEIGHT = 1000; // –í—ã—Å–æ—Ç–∞ —Å–µ–∫—Ç–æ—Ä–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö (—É–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ —á–∞—Å—Ç–æ–π —Å–º–µ–Ω—ã)
        let currentSector = 0; // –¢–µ–∫—É—â–∏–π —Å–µ–∫—Ç–æ—Ä
        let platformGroups = []; // –ì—Ä—É–ø–ø—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è

        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–Ω—Å—Ç—Ä–æ–≤
        const monsterImageLeft = new Image(); // –ú–æ–Ω—Å—Ç—Ä —Å–º–æ—Ç—Ä–∏—Ç –≤–ª–µ–≤–æ
        monsterImageLeft.src = 'https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeib37u73k7k33uxlemsj6ubwn5kzrc55w4ba72dc2ocsv5ea7cyzuy';
        let monsterImageLeftLoaded = false;
        monsterImageLeft.onload = () => {
            monsterImageLeftLoaded = true;
        };

        const monsterImageRight = new Image(); // –ú–æ–Ω—Å—Ç—Ä —Å–º–æ—Ç—Ä–∏—Ç –≤–ø—Ä–∞–≤–æ
        monsterImageRight.src = 'https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeihi27typfofxqqlsbcq5nucomggj6asbfdbk6da64jpmgj5y4bbai';
        let monsterImageRightLoaded = false;
        monsterImageRight.onload = () => {
            monsterImageRightLoaded = true;
        };

        // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–º–æ–Ω—Å—Ç—Ä—ã)
        let monsters = [];
        let hiddenMonsters = []; // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç—ã–µ –º–æ–Ω—Å—Ç—Ä—ã
        const MONSTER_SIZE = 50; // –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–µ–Ω (–±—ã–ª–æ 66)

        // –°–ø—Ä–∞–π—Ç —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞–Ω—Ü–∞
        const jetpackImage = new Image();
        jetpackImage.src = 'https://aquamarine-past-gamefowl-916.mypinata.cloud/ipfs/bafybeiegyn7ctgc7rtrvwo36ivhfttxxjsqz75qd6ze2awcwxxer5lzkdi';
        let jetpackImageLoaded = false;
        jetpackImage.onload = () => {
            jetpackImageLoaded = true;
        };

        // –†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞–Ω—Ü—ã
        let jetpacks = [];
        let hiddenJetpacks = []; // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç—ã–µ —Ä–∞–Ω—Ü—ã
        const JETPACK_SIZE = 40;

        // –ü—Ä—É–∂–∏–Ω—ã
        let springs = [];
        const SPRING_SIZE = 25;
        
        // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—â–∏–µ –ø—Ä—É–∂–∏–Ω—ã (–¥–ª—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –º–∏—Ä–∞)
        let invertSprings = [];
        const INVERT_SPRING_SIZE = 40;
        let invertSpring1Created = false; // –ü—Ä—É–∂–∏–Ω–∞ –Ω–∞ 3500 (–ø–µ—Ä–µ–≤–æ—Ä–æ—Ç)
        let invertSpring2Created = false; // –ü—Ä—É–∂–∏–Ω–∞ –Ω–∞ 4000 (–≤–æ–∑–≤—Ä–∞—Ç)
        const FLIP_DURATION = 500; // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ (–º—Å)
        
        // –§–æ–Ω–∞—Ä–∏
        let lanterns = [];
        const LANTERN_SIZE = 50;
        const LANTERN_SPAWN_SCORE = 2000; // –§–æ–Ω–∞—Ä—å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞ 2000 –æ—á–∫–æ–≤
        let lanternCreated = false; // –§–ª–∞–≥: –±—ã–ª –ª–∏ —Ñ–æ–Ω–∞—Ä—å —Å–æ–∑–¥–∞–Ω —Ö–æ—Ç—è –±—ã —Ä–∞–∑
        let lanternY = null; // Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å —Ñ–æ–Ω–∞—Ä–µ–º (–¥–ª—è —Ç–µ–º–Ω–æ—Ç—ã)
        const DARKNESS_HEIGHT = 50 * 70; // –í—ã—Å–æ—Ç–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ —Ç–µ–º–Ω–æ—Ç—ã = 50 –ø–ª–∞—Ç—Ñ–æ—Ä–º * 70px

        // –§–∏–∑–∏–∫–∞
        const GRAVITY = 0.24; // 0.3 * 0.8 (–∑–∞–º–µ–¥–ª–µ–Ω–æ –Ω–∞ 20%)
        const JUMP_POWER = -8;
        const SPRING_POWER = -15; // –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –Ω–∞ –ø—Ä–µ–∂–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        const JETPACK_POWER = -0.64; // -0.8 * 0.8 (–∑–∞–º–µ–¥–ª–µ–Ω–æ –Ω–∞ 20%)
        const MAX_SPEED = 6; // –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –Ω–∞ –ø—Ä–µ–∂–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        const ACCELERATION = 1.0; // –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –Ω–∞ –ø—Ä–µ–∂–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        const FRICTION = 0.88;

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        let keys = {};
        let touchLeft = false;
        let touchRight = false;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ—Ä–¥–∞
        function loadHighScore() {
            if (tg?.initDataUnsafe?.user?.id) {
                const saved = localStorage.getItem(`highScore_${tg.initDataUnsafe.user.id}`);
                highScore = saved ? parseInt(saved) : 0;
            } else {
                highScore = parseInt(localStorage.getItem('highScore') || '0');
            }
            highScoreEl.textContent = `–†–µ–∫–æ—Ä–¥: ${highScore}`;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞
        function saveHighScore() {
            if (score > highScore) {
                highScore = score;
                if (tg?.initDataUnsafe?.user?.id) {
                    localStorage.setItem(`highScore_${tg.initDataUnsafe.user.id}`, highScore.toString());
                } else {
                    localStorage.setItem('highScore', highScore.toString());
                }
                highScoreEl.textContent = `–†–µ–∫–æ—Ä–¥: ${highScore}`;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            gameState = 'playing';
            score = 0;
            platforms = [];
            monsters = [];
            jetpacks = [];
            springs = [];
            lanterns = [];
            lanternCreated = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ–Ω–∞—Ä—è
            invertSprings = [];
            invertSpring1Created = false;
            invertSpring2Created = false;
            hiddenMonsters = [];
            hiddenJetpacks = [];

            // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞ –≤ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
            // –ò–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω –Ω–∞ 70% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
            const startPlayerWorldY = 0;
            player.x = canvas.width / 2 - player.width / 2;
            player.y = startPlayerWorldY;
            player.velocityX = 0;
            player.velocityY = 0;
            player.onPlatform = false;
            highestPlayerY = startPlayerWorldY; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É
            player.hasJetpack = false;
            player.jetpackStartTime = 0;
            player.jetpackDuration = 1500;
            player.immunityEndTime = 0;
            player.monstersHiddenUntil = 0;
            player.jetpacksHiddenUntil = 0;
            player.hasLantern = false;
            player.lightRadius = 0;
            player.isInverted = false;
            player.isFlipping = false;
            player.flipStartTime = 0;
            lanternY = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É —Ñ–æ–Ω–∞—Ä—è
            hiddenMonsters = [];
            hiddenJetpacks = [];
            player.facingRight = false; // –ù–∞—á–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã —Ç–∞–∫, —á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ –±—ã–ª –≤–∏–¥–µ–Ω –Ω–∞ 70% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
            cameraY = startPlayerWorldY - canvas.height * 0.7;

            // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –ø—Ä—è–º–æ –ø–æ–¥ –∏–≥—Ä–æ–∫–æ–º
            platforms.push({
                x: canvas.width / 2 - PLATFORM_WIDTH / 2,
                y: startPlayerWorldY + player.height,
                width: PLATFORM_WIDTH,
                height: PLATFORM_HEIGHT,
                type: 'normal',
                moveDirection: 1,
                moveSpeed: 2,
                spriteIndex: 0 // –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å 0 –∏–ª–∏ 1
            });

            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º –≤—ã—à–µ (—É–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Ç–∞–∫ –∫–∞–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å—Ç–∞–ª–∏ –±–æ–ª—å—à–µ)
            for (let i = 1; i < 50; i++) {
                createPlatform(startPlayerWorldY - i * PLATFORM_SPACING);
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤ (—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
            // –í—Ä–∞–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
            let jetpackCounter = 0;
            for (let i = 5; i < 50; i++) {
                const y = startPlayerWorldY - i * PLATFORM_SPACING;
                
                // –†–∞–Ω–µ—Ü –∫–∞–∂–¥—ã–µ 10 –ø–ª–∞—Ç—Ñ–æ—Ä–º (—Ç–æ–ª—å–∫–æ –¥–æ 800 –æ—á–∫–æ–≤!)
                const potentialScore = Math.floor((0 - y) / 10);
                jetpackCounter++;
                if (jetpackCounter >= 10 && potentialScore < 800) {
                    createJetpack(y);
                    jetpackCounter = 0;
                }
                // –ü—Ä—É–∂–∏–Ω—ã —Å–∫—Ä—ã—Ç—ã
            }

            startScreen.classList.add('hidden');
            const flagImage = document.getElementById('flagImage');
            const startBtn = document.getElementById('startBtn');
            const heroOnButton = document.getElementById('heroOnButton');
            if (flagImage) flagImage.style.display = 'none';
            if (startBtn) startBtn.style.display = 'none';
            if (heroOnButton) heroOnButton.style.display = 'none';
            gameOverEl.style.display = 'none';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á–µ—Ç –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
            scoreEl.style.display = 'block';
            scoreTextEl.textContent = '0';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
            const controlsEl = document.getElementById('controls');
            if (controlsEl) controlsEl.style.display = 'flex';
            // –°–∫—Ä—ã–≤–∞–µ–º CSS —Ñ–æ–Ω–∞—Ä—å
            const cssLanternEl = document.getElementById('cssLantern');
            if (cssLanternEl) cssLanternEl.style.display = 'none';
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–µ–∫—Ç–æ—Ä–∞ (–∫–∞–∫–æ–π —Ç–∏–ø –ø–ª–∞—Ç—Ñ–æ—Ä–º –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å)
        function getSectorType(y) {
            const sectorIndex = Math.floor(Math.abs(y) / SECTOR_HEIGHT);
            const sectorPattern = sectorIndex % 8; // 8 —Ç–∏–ø–æ–≤ —Å–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            
            // –ù–∞—á–∏–Ω–∞–µ–º —Å—Ä–∞–∑—É —Å–æ —Å–ª–æ–∂–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π –∏–≥—Ä—ã
            switch(sectorPattern) {
                case 0: return 'mixEasy'; // –ü—Ä–æ—Å—Ç–æ–π –º–∏–∫—Å: 80% –æ–±—ã—á–Ω—ã—Ö, 20% –¥–≤–∏–∂—É—â–∏—Ö—Å—è
                case 1: return 'mixMedium'; // –°—Ä–µ–¥–Ω–∏–π –º–∏–∫—Å: 60% –æ–±—ã—á–Ω—ã—Ö, 30% –¥–≤–∏–∂—É—â–∏—Ö—Å—è, 10% fading
                case 2: return 'oneTouch'; // –°–µ–∫—Ç–æ—Ä —Å –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏
                case 3: return 'mixHard'; // –°–ª–æ–∂–Ω—ã–π –º–∏–∫—Å: 40% –æ–±—ã—á–Ω—ã—Ö, 30% –¥–≤–∏–∂—É—â–∏—Ö—Å—è, 20% –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã—Ö, 10% fading
                case 4: return 'fading'; // –°–µ–∫—Ç–æ—Ä —Å –∏—Å—á–µ–∑–∞—é—â–∏–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏ (3 –∫–∞—Å–∞–Ω–∏—è)
                case 5: return 'mixMedium'; // –°—Ä–µ–¥–Ω–∏–π –º–∏–∫—Å
                case 6: return 'mixHard'; // –°–ª–æ–∂–Ω—ã–π –º–∏–∫—Å
                case 7: return 'oneTouch'; // –°–µ–∫—Ç–æ—Ä —Å –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏
                default: return 'mixMedium'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ä–µ–¥–Ω–∏–π –º–∏–∫—Å
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        function createPlatform(y, forceType = null) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ —Ç–µ–º–Ω–æ—Ç–µ (2000-3000 –æ—á–∫–æ–≤)
            // Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å—á–µ—Ç–∞: score = -y / 10
            const potentialScore = Math.floor((0 - y) / 10);
            const inDarkness = potentialScore >= 2000 && potentialScore < 3000;
            const inFirstHalfOfDarkness = potentialScore >= 2000 && potentialScore < 2500;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–µ–∫—Ç–æ—Ä–∞
            const sectorType = forceType || getSectorType(y);
            let platformType = 'normal';
            let specialProps = {};
            
            // –í –õ–Æ–ë–û–ô —Ç–µ–º–Ω–æ—Ç–µ (2000-3000 –æ—á–∫–æ–≤) —É–ø—Ä–æ—â–∞–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã - –ë–ï–ó –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã—Ö –∏ –∏—Å—á–µ–∑–∞—é—â–∏—Ö!
            if (inDarkness) {
                // –í–û –í–°–ï–ô —Ç–µ–º–Ω–æ—Ç–µ - —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ –∏ –¥–≤–∏–∂—É—â–∏–µ—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–±–µ–∑ oneTouch –∏ fading)
                if (sectorType.includes('mix')) {
                    const rand = Math.random();
                    if (rand < 0.3) {
                        platformType = 'moving';
                    } else {
                        platformType = 'normal';
                    }
                } else {
                    platformType = 'normal';
                }
            } else {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ–∫—Ç–æ—Ä–∞ (–æ–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞)
                if (sectorType === 'normal') {
                    // –û–±—ã—á–Ω—ã–π —Å–µ–∫—Ç–æ—Ä - —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                    platformType = 'normal';
                } else if (sectorType === 'oneTouch') {
                    // –í —Å–µ–∫—Ç–æ—Ä–µ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º - —Ç–æ–ª—å–∫–æ –æ–Ω–∏
                    platformType = 'oneTouch';
                    specialProps = {
                        touched: false,
                        disappearsImmediately: true
                    };
                } else if (sectorType === 'fading') {
                    // –í —Å–µ–∫—Ç–æ—Ä–µ –∏—Å—á–µ–∑–∞—é—â–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º - —Ç–æ–ª—å–∫–æ –æ–Ω–∏ (3 –∫–∞—Å–∞–Ω–∏—è)
                    platformType = 'fading';
                    specialProps = {
                        maxTouches: 3,
                        currentTouches: 0,
                        opacity: 1.0
                    };
                } else if (sectorType === 'breaking') {
                    // Breaking —Å–µ–∫—Ç–æ—Ä –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –æ–±—ã—á–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                    platformType = 'normal';
                } else if (sectorType === 'mixEasy') {
                    // –ü—Ä–æ—Å—Ç–æ–π –º–∏–∫—Å: 80% –æ–±—ã—á–Ω—ã—Ö, 20% –¥–≤–∏–∂—É—â–∏—Ö—Å—è
                    const rand = Math.random();
                    if (rand < 0.2) {
                        platformType = 'moving';
                    } else {
                        platformType = 'normal';
                    }
                } else if (sectorType === 'mixMedium') {
                    // –°—Ä–µ–¥–Ω–∏–π –º–∏–∫—Å: 60% –æ–±—ã—á–Ω—ã—Ö, 30% –¥–≤–∏–∂—É—â–∏—Ö—Å—è, 10% fading
                    const rand = Math.random();
                    if (rand < 0.3) {
                        platformType = 'moving';
                    } else if (rand < 0.4) {
                        platformType = 'fading';
                        specialProps = {
                            maxTouches: 3,
                            currentTouches: 0,
                            opacity: 1.0
                        };
                    } else {
                        platformType = 'normal';
                    }
                } else if (sectorType === 'mixHard') {
                    // –°–ª–æ–∂–Ω—ã–π –º–∏–∫—Å: 40% –æ–±—ã—á–Ω—ã—Ö, 30% –¥–≤–∏–∂—É—â–∏—Ö—Å—è, 20% –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã—Ö, 10% fading
                    const rand = Math.random();
                    if (rand < 0.3) {
                        platformType = 'moving';
                    } else if (rand < 0.5) {
                        platformType = 'oneTouch';
                        specialProps = {
                            touched: false,
                            disappearsImmediately: true
                        };
                    } else if (rand < 0.6) {
                        platformType = 'fading';
                        specialProps = {
                            maxTouches: 3,
                            currentTouches: 0,
                            opacity: 1.0
                        };
                    } else {
                        platformType = 'normal';
                    }
                } else {
                    // Fallback - –æ–±—ã—á–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
                    platformType = 'normal';
                }
            }
            
            // –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º –ø–æ –≤—Å–µ–π —à–∏—Ä–∏–Ω–µ —ç–∫—Ä–∞–Ω–∞
            // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ –≤—Å–µ–º —É–≥–ª–∞–º –∏ –∫—Ä–∞—è–º –∫–∞—Ä—Ç—ã
            const platformX = Math.random() * (canvas.width - PLATFORM_WIDTH);
            
            // –ù–µ —Å–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ —Ñ–æ–Ω–∞—Ä–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ (Y = -20000)
            const lanternPlatformY = -20000;
            const distanceToLantern = Math.abs(y - lanternPlatformY);
            if (lanternCreated && distanceToLantern < 100) {
                return null; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
            }
            
            const platform = {
                x: platformX,
                y: y,
                width: PLATFORM_WIDTH,
                height: PLATFORM_HEIGHT,
                type: platformType,
                moveDirection: Math.random() < 0.5 ? 1 : -1,
                moveSpeed: 2,
                ...specialProps
            };
            
            platforms.push(platform);
            return platform;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–Ω—Å—Ç—Ä–∞
        function createMonster(y) {
            monsters.push({
                x: Math.random() * (canvas.width - MONSTER_SIZE),
                y: y - 40,
                size: MONSTER_SIZE,
                moveDirection: Math.random() < 0.5 ? 1 : -1,
                moveSpeed: 1.5
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞–Ω—Ü–∞
        function createJetpack(y) {
            jetpacks.push({
                x: Math.random() * (canvas.width - JETPACK_SIZE),
                y: y - 40,
                size: JETPACK_SIZE
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä—É–∂–∏–Ω—ã
        function createSpring(y) {
            springs.push({
                x: Math.random() * (canvas.width - SPRING_SIZE),
                y: y - 15,
                size: SPRING_SIZE
            });
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—â–µ–π –ø—Ä—É–∂–∏–Ω—ã
        function createInvertSpring(platformX, platformY, platformWidth, platformHeight, invertTo) {
            // –ü–µ—Ä–≤–∞—è –ø—Ä—É–∂–∏–Ω–∞ (–ø–µ—Ä–µ–≤–æ—Ä–æ—Ç) - —Å–≤–µ—Ä—Ö—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–Ω–µ –∫–∞—Å–∞–µ—Ç—Å—è)
            // –í—Ç–æ—Ä–∞—è –ø—Ä—É–∂–∏–Ω–∞ (–≤–æ–∑–≤—Ä–∞—Ç) - —Å–Ω–∏–∑—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–Ω–µ –∫–∞—Å–∞–µ—Ç—Å—è, —É–¥–æ–±–Ω–æ –≤ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ)
            let springWorldY;
            if (invertTo) {
                // –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç - –°–í–ï–†–•–£, —Å –æ—Ç—Å—Ç—É–ø–æ–º 2px –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                springWorldY = platformY - INVERT_SPRING_SIZE - 2;
            } else {
                // –í–æ–∑–≤—Ä–∞—Ç - –°–ù–ò–ó–£, —Å –æ—Ç—Å—Ç—É–ø–æ–º 2px –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                springWorldY = platformY + platformHeight + 2;
            }
            
            invertSprings.push({
                x: platformX + platformWidth / 2 - INVERT_SPRING_SIZE / 2, // –ü–æ —Ü–µ–Ω—Ç—Ä—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                y: springWorldY,
                size: INVERT_SPRING_SIZE,
                invertTo: invertTo // true = –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç, false = –≤–æ–∑–≤—Ä–∞—Ç
            });
            console.log('üåÄ –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—â–∞—è –ø—Ä—É–∂–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ Y:', springWorldY, 'invertTo:', invertTo, '–ø–æ–∑–∏—Ü–∏—è:', invertTo ? '–°–í–ï–†–•–£‚Üë' : '–°–ù–ò–ó–£‚Üì');
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ–Ω–∞—Ä—è
        function createLantern(platformX, platformY, platformWidth) {
            // –§–æ–Ω–∞—Ä—å –≤–∏—Å–∏—Ç –≤ 4 –ø–∏–∫—Å–µ–ª—è—Ö –Ω–∞–¥ –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π
            // platformY - —ç—Ç–æ –í–ï–†–• –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            // –ù–ò–ó –∑–æ–Ω—ã –ø–æ–¥–±–æ—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ platformY - 4
            // –ó–Ω–∞—á–∏—Ç –í–ï–†–• –∑–æ–Ω—ã –ø–æ–¥–±–æ—Ä–∞ (lantern.y) = platformY - 4 - LANTERN_SIZE
            const lanternWorldY = platformY - 4 - LANTERN_SIZE; // –í–µ—Ä—Ö –∑–æ–Ω—ã –ø–æ–¥–±–æ—Ä–∞
            lanterns.push({
                x: platformX + platformWidth / 2 - LANTERN_SIZE / 2, // –ü–æ —Ü–µ–Ω—Ç—Ä—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                y: lanternWorldY, // –í–µ—Ä—Ö –∑–æ–Ω—ã –ø–æ–¥–±–æ—Ä–∞
                size: LANTERN_SIZE
            });
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É —Ñ–æ–Ω–∞—Ä—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ç–µ–º–Ω–æ—Ç—ã
            lanternY = lanternWorldY;
            console.log('üìç –§–æ–Ω–∞—Ä—å —Å–æ–∑–¥–∞–Ω –Ω–∞ Y:', lanternY, '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –Ω–∞ Y:', platformY);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchLeft = true;
        });
        leftBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            touchLeft = false;
        });
        leftBtn.addEventListener('mousedown', () => touchLeft = true);
        leftBtn.addEventListener('mouseup', () => touchLeft = false);
        leftBtn.addEventListener('mouseleave', () => touchLeft = false);

        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchRight = true;
        });
        rightBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            touchRight = false;
        });
        rightBtn.addEventListener('mousedown', () => touchRight = true);
        rightBtn.addEventListener('mouseup', () => touchRight = false);
        rightBtn.addEventListener('mouseleave', () => touchRight = false);

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
        function update() {
            if (gameState !== 'playing') return;

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            let isMoving = false;
            if (keys['ArrowLeft'] || keys['a'] || keys['A'] || touchLeft) {
                player.velocityX -= ACCELERATION;
                player.facingRight = false; // –°–º–æ—Ç—Ä–∏–º –≤–ª–µ–≤–æ
                isMoving = true;
            }
            if (keys['ArrowRight'] || keys['d'] || keys['D'] || touchRight) {
                player.velocityX += ACCELERATION;
                player.facingRight = true; // –°–º–æ—Ç—Ä–∏–º –≤–ø—Ä–∞–≤–æ
                isMoving = true;
            }

            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
            player.velocityX = Math.max(-MAX_SPEED, Math.min(MAX_SPEED, player.velocityX));
            
            // –¢—Ä–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è
            if (!isMoving) {
                player.velocityX *= FRICTION;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
            player.x += player.velocityX;

            // –í—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞ (—Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è)
            if (player.x < -player.width) {
                player.x = canvas.width;
            } else if (player.x > canvas.width) {
                player.x = -player.width;
            }

            // –ü–û–î–ë–û–† –†–ê–ù–¶–ê –î–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø –§–ò–ó–ò–ö–ò (—á—Ç–æ–±—ã —Ç–æ–ø–ª–∏–≤–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–æ—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
            // –ü–æ–¥–±–æ—Ä —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞–Ω—Ü–∞
            for (let jetpack of jetpacks) {
                if (player.x + player.width > jetpack.x &&
                    player.x < jetpack.x + jetpack.size &&
                    player.y + player.height > jetpack.y &&
                    player.y < jetpack.y + jetpack.size) {
                    // –†–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞–Ω–µ—Ü: 2 —Å–µ–∫—É–Ω–¥—ã
                    // –°–¢–†–û–ì–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ä–∞–Ω–µ—Ü
                    const currentTime = Date.now();
                    let canPickup = false;
                    
                    // –°–¢–†–û–ì–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–Ω—Ü–∞
                    if (!player.hasJetpack) {
                        // –†–∞–Ω–µ—Ü –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω - –º–æ–∂–Ω–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å
                        canPickup = true;
                    } else if (player.jetpackStartTime > 0) {
                        // –†–∞–Ω–µ—Ü –∞–∫—Ç–∏–≤–µ–Ω - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ 2 —Å–µ–∫—É–Ω–¥—ã
                        const elapsed = currentTime - player.jetpackStartTime;
                        canPickup = (elapsed >= 2000);
                        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–±–æ—Ä–∞ —Ä–∞–Ω—Ü–∞: elapsed =', elapsed, 'canPickup =', canPickup);
                    } else {
                        // hasJetpack = true, –Ω–æ –≤—Ä–µ–º—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ - –º–æ–∂–Ω–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å (–∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
                        canPickup = true;
                    }
                    
                    if (canPickup) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–Ω–µ—Ü
                        player.hasJetpack = true;
                        player.jetpackStartTime = currentTime; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                        player.jetpackDuration = 1500; // –û–±—ã—á–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                        
                        // –°–ö–†–´–í–ê–ï–ú –≤—Å–µ –º–æ–Ω—Å—Ç—Ä—ã –∏ —Ä–∞–Ω—Ü—ã –Ω–∞ –≤—Ä–µ–º—è –ø–æ–ª–µ—Ç–∞ + 5 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ
                        const hideUntil = currentTime + player.jetpackDuration + 5000;
                        player.monstersHiddenUntil = hideUntil;
                        player.jetpacksHiddenUntil = hideUntil;
                        
                        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –º–æ–Ω—Å—Ç—Ä—ã –∏ —Ä–∞–Ω—Ü—ã –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                        hiddenMonsters = [...monsters];
                        hiddenJetpacks = [...jetpacks];
                        monsters = [];
                        jetpacks = [];
                        
                        console.log('–†–ê–ù–ï–¶ –ü–û–î–û–ë–†–ê–ù! –ú–æ–Ω—Å—Ç—Ä—ã –∏ —Ä–∞–Ω—Ü—ã —Å–∫—Ä—ã—Ç—ã –¥–æ:', hideUntil);
                        break; // –ü–æ–¥–æ–±—Ä–∞–ª–∏ —Ä–∞–Ω–µ—Ü, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
                    } else {
                        // –†–∞–Ω–µ—Ü —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω - —É–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç, —á—Ç–æ–±—ã –Ω–µ –ø–æ–¥–æ–±—Ä–∞—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞
                        jetpacks = jetpacks.filter(j => j !== jetpack);
                        break;
                    }
                }
            }

            // –†–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞–Ω–µ—Ü (2 —Å–µ–∫—É–Ω–¥—ã) - –°–¢–†–û–ì–ê–Ø –ü–†–û–í–ï–†–ö–ê
            const updateTime = Date.now();
            
            // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –º–æ–Ω—Å—Ç—Ä—ã –∏ —Ä–∞–Ω—Ü—ã –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –≤—Ä–µ–º—è —Å–∫—Ä—ã—Ç–∏—è
            if (updateTime >= player.monstersHiddenUntil && hiddenMonsters.length > 0) {
                monsters = [...hiddenMonsters];
                hiddenMonsters = [];
                player.monstersHiddenUntil = 0;
            }
            if (updateTime >= player.jetpacksHiddenUntil && hiddenJetpacks.length > 0) {
                jetpacks = [...hiddenJetpacks];
                hiddenJetpacks = [];
                player.jetpacksHiddenUntil = 0;
            }
            
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ñ–∏–∑–∏–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ (–æ–±—ã—á–Ω—ã–π / –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
            const currentGravity = player.isInverted ? -GRAVITY : GRAVITY;
            const currentJumpPower = player.isInverted ? -JUMP_POWER : JUMP_POWER;
            const currentJetpackPower = player.isInverted ? -JETPACK_POWER : JETPACK_POWER;
            
            // –†–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞–Ω–µ—Ü (2 —Å–µ–∫—É–Ω–¥—ã) - –°–¢–†–û–ì–ê–Ø –ü–†–û–í–ï–†–ö–ê
            // –°–¢–†–û–ì–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ—Ç–∫–ª—é—á–∞–µ–º —Ä–∞–Ω–µ—Ü –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (player.hasJetpack) {
                    // –°–¢–†–û–ì–û: –µ—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ - –û–¢–ö–õ–Æ–ß–ê–ï–ú –°–†–ê–ó–£
                if (player.jetpackStartTime <= 0) {
                    console.log('–†–ê–ù–ï–¶ –û–¢–ö–õ–Æ–ß–ï–ù! –í—Ä–µ–º—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    player.hasJetpack = false;
                    player.jetpackStartTime = 0;
                    player.velocityY += currentGravity;
                } else {
                    // –°–¢–†–û–ì–û: –≤—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
                    const elapsed = updateTime - player.jetpackStartTime;
                    
                    // –°–¢–†–û–ì–û: –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ >= 1500 –º—Å (1.5 —Å–µ–∫) - –û–¢–ö–õ–Æ–ß–ê–ï–ú (—Ö–≤–∞—Ç–∏—Ç –Ω–∞ ~1500 –æ—á–∫–æ–≤)
                    if (elapsed >= 1500) {
                        console.log('–†–ê–ù–ï–¶ –û–¢–ö–õ–Æ–ß–ï–ù! elapsed:', elapsed);
                        player.hasJetpack = false;
                        player.jetpackStartTime = 0;
                        player.immunityEndTime = updateTime + 5000;
                        player.velocityY += currentGravity;
                    } else {
                        // –†–∞–Ω–µ—Ü –∞–∫—Ç–∏–≤–µ–Ω - –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∏–ª—É
                        player.velocityY += currentJetpackPower;
                    }
                }
            } else {
                // –†–∞–Ω–µ—Ü –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω - –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
                // –°–¢–†–û–ì–û: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ —Ä–∞–Ω–µ—Ü –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
                if (player.jetpackStartTime > 0) {
                    player.jetpackStartTime = 0;
                }
                player.velocityY += currentGravity;
            }

            player.y += player.velocityY;
            player.onPlatform = false;

            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏
            for (let i = platforms.length - 1; i >= 0; i--) {
                const platform = platforms[i];
                
                // –î–≤–∏–∂—É—â–∏–µ—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                if (platform.type === 'moving') {
                    platform.x += platform.moveSpeed * platform.moveDirection;
                    if (platform.x < 0 || platform.x > canvas.width - platform.width) {
                        platform.moveDirection *= -1;
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è (–≤ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö)
                let collision = false;
                
                if (!player.isInverted) {
                    // –û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú: —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –í–ï–†–•–û–ú –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                    if (player.velocityY > 0 &&
                        player.x + player.width > platform.x &&
                        player.x < platform.x + platform.width &&
                        player.y + player.height > platform.y &&
                        player.y + player.height < platform.y + platform.height + 10) {
                        
                        player.y = platform.y - player.height;
                        player.velocityY = currentJumpPower;
                        player.onPlatform = true;
                        collision = true;
                    }
                } else {
                    // –ò–ù–í–ï–†–¢–ò–†–û–í–ê–ù–ù–´–ô –†–ï–ñ–ò–ú: —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –ù–ò–ó–û–ú –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                    if (player.velocityY < 0 && // –ò–≥—Ä–æ–∫ –¥–≤–∏–≥–∞–µ—Ç—Å—è –≤–≤–µ—Ä—Ö (–ø–∞–¥–∞–µ—Ç "–≤–≤–µ—Ä—Ö")
                        player.x + player.width > platform.x &&
                        player.x < platform.x + platform.width &&
                        player.y < platform.y + platform.height + 10 && // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ–π –≤—ã—Å–æ—Ç—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                        player.y > platform.y - player.height) { // –í–µ—Ä—Ö –∏–≥—Ä–æ–∫–∞ –≤—ã—à–µ –≤–µ—Ä—Ö–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                        
                        player.y = platform.y + platform.height; // –ü—Ä–∏–ª–∏–ø–∞–µ–º –∫ –Ω–∏–∑—É
                        player.velocityY = currentJumpPower; // –ü—Ä—ã–≥–∞–µ–º "–≤–Ω–∏–∑" –æ—Ç –Ω–∏–∑–∞
                        player.onPlatform = true;
                        collision = true;
                    }
                }
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–æ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ)
                if (collision) {
                    if (platform.type === 'oneTouch') {
                        // –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ - –∏—Å—á–µ–∑–∞–µ—Ç –°–†–ê–ó–£ –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏, –Ω–æ –¥–∞–µ—Ç –ø—Ä—ã–∂–æ–∫
                        platforms.splice(i, 1);
                    } else if (platform.type === 'fading') {
                        // –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ –∫–∞—Å–∞–Ω–∏—è–º–∏
                        platform.currentTouches = (platform.currentTouches || 0) + 1;
                        platform.opacity = 1.0 - (platform.currentTouches / platform.maxTouches) * 0.8;
                        if (platform.currentTouches >= platform.maxTouches) {
                            platforms.splice(i, 1);
                        }
                    }
                }
            }

            // –ü—Ä—É–∂–∏–Ω—ã —Å–∫—Ä—ã—Ç—ã (–Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è)
            
            // –ü–æ–¥–±–æ—Ä —Ñ–æ–Ω–∞—Ä—è
            for (let i = lanterns.length - 1; i >= 0; i--) {
                const lantern = lanterns[i];
                if (player.x + player.width > lantern.x &&
                    player.x < lantern.x + lantern.size &&
                    player.y + player.height > lantern.y &&
                    player.y < lantern.y + lantern.size) {
                    // –ü–æ–¥–æ–±—Ä–∞–ª–∏ —Ñ–æ–Ω–∞—Ä—å!
                    player.hasLantern = true;
                    player.lightRadius = 100; // –†–∞–¥–∏—É—Å –æ—Å–≤–µ—â–µ–Ω–∏—è 100px
                    lanterns.splice(i, 1);
                    console.log('üî¶ –§–û–ù–ê–†–¨ –ü–û–î–û–ë–†–ê–ù! –†–∞–¥–∏—É—Å —Å–≤–µ—Ç–∞:', player.lightRadius);
                }
            }
            
            // –ü–æ–¥–±–æ—Ä –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—â–µ–π –ø—Ä—É–∂–∏–Ω—ã (–ø–æ—Ä—Ç–∞–ª–∞) - —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
            for (let i = invertSprings.length - 1; i >= 0; i--) {
                const spring = invertSprings[i];
                
                // –î–ª—è –≤—Ç–æ—Ä–æ–π —Å—Ñ–µ—Ä—ã (–≤–æ–∑–≤—Ä–∞—Ç) —Ä–∞—Å—à–∏—Ä—è–µ–º –∑–æ–Ω—É –ø–æ–¥–±–æ—Ä–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ —Ä—è–¥–æ–º
                const isReturnSpring = !spring.invertTo; // false = –≤–æ–∑–≤—Ä–∞—Ç
                let canPickup = false;
                
                if (isReturnSpring) {
                    // –í–¢–û–†–ê–Ø –°–§–ï–†–ê (–≤–æ–∑–≤—Ä–∞—Ç): –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –°–ù–ò–ó–£ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –∏–≥—Ä–æ–∫ –≤–∏—Å–∏—Ç –ù–ê–î –Ω–µ–π
                    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ –ø–æ–¥–±–æ—Ä–∞ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (–≤ 2.5 —Ä–∞–∑–∞ —à–∏—Ä–µ)
                    const pickupZoneWidth = spring.size * 2.5;
                    const pickupZoneX = spring.x - (pickupZoneWidth - spring.size) / 2;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∑–æ–Ω–∞)
                    const horizontalOverlap = player.x + player.width > pickupZoneX &&
                                             player.x < pickupZoneX + pickupZoneWidth;
                    
                    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ –ø–æ–¥–±–æ—Ä–∞ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –í–í–ï–†–• (–∏–≥—Ä–æ–∫ –≤—ã—à–µ —Å—Ñ–µ—Ä—ã, –≤–∏—Å–∏—Ç –Ω–∞ –ø–æ—Ç–æ–ª–∫–µ)
                    // –°—Ñ–µ—Ä–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ spring.y, –∏–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ 200px –≤—ã—à–µ
                    const springTop = spring.y;
                    const springBottom = spring.y + spring.size;
                    const playerBottom = player.y + player.height; // –ù–æ–≥–∏ –∏–≥—Ä–æ–∫–∞ (–≤–∏—Å—è—Ç –Ω–∞ –ø–æ—Ç–æ–ª–∫–µ)
                    
                    // –ò–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∑–æ–Ω–µ: –æ—Ç —Å—Ñ–µ—Ä—ã –¥–æ 200px –≤—ã—à–µ
                    const verticalInRange = playerBottom >= springTop - 200 && 
                                           playerBottom <= springBottom + 50;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ —Å—Ç–æ–∏—Ç –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –ò –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∑–æ–Ω–µ –ø–æ–¥–±–æ—Ä–∞
                    canPickup = player.onPlatform && 
                               horizontalOverlap && 
                               verticalInRange;
                } else {
                    // –ü–ï–†–í–ê–Ø –°–§–ï–†–ê (–ø–µ—Ä–µ–≤–æ—Ä–æ—Ç): –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∫ –≤ —Ç–µ—Å—Ç123.html
                    const touchesSpring = player.x + player.width > spring.x &&
                                         player.x < spring.x + spring.size &&
                                         player.y + player.height > spring.y &&
                                         player.y < spring.y + spring.size;
                    canPickup = touchesSpring && player.onPlatform;
                }
                
                if (canPickup) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ñ–µ—Ä–∞ (–ø–µ—Ä–µ–≤–æ—Ä–æ—Ç) - —É–¥–∞–ª—è–µ–º –≤—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –Ω–∏–∂–µ –Ω–µ—ë
                    if (spring.invertTo) {
                        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∏–∂–µ (y > spring.y, —Ç–∞–∫ –∫–∞–∫ y –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏ –ø–æ–¥—ä–µ–º–µ)
                        // –ù–∞–ø—Ä–∏–º–µ—Ä: —Å—Ñ–µ—Ä–∞ –Ω–∞ y = -50000, –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –Ω–∞ y = -10000 (–±–æ–ª—å—à–µ) –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∏–∂–µ
                        // –ù–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É —Å –ø–æ—Ä—Ç–∞–ª–æ–º (isSpring1Platform)
                        const springY = spring.y;
                        platforms = platforms.filter(p => {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É —Å –ø–æ—Ä—Ç–∞–ª–æ–º
                            if (p.isSpring1Platform) {
                                return true;
                            }
                            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –Ω–∏–∂–µ —Å—Ñ–µ—Ä—ã (y > spring.y, —Ç.–µ. –º–µ–Ω–µ–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
                            // –ù–∞–ø—Ä–∏–º–µ—Ä: —Å—Ñ–µ—Ä–∞ –Ω–∞ y = -50000, —É–¥–∞–ª—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –Ω–∞ y = -10000 (–±–æ–ª—å—à–µ, –Ω–∏–∂–µ)
                            // –í filter() –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º, –∫–æ—Ç–æ—Ä—ã–µ –û–°–¢–ê–í–õ–Ø–ï–ú
                            return p.y <= springY;
                        });
                        console.log('üóëÔ∏è –£–î–ê–õ–ï–ù–´ –í–°–ï –ü–õ–ê–¢–§–û–†–ú–´ –ù–ò–ñ–ï –ü–ï–†–í–û–ô –°–§–ï–†–´! Y –ø–æ—Ä—Ç–∞–ª–∞:', springY);
                    }
                    
                    // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç
                    player.isFlipping = true;
                    player.flipStartTime = Date.now();
                    player.isInverted = spring.invertTo;
                    player.velocityY = -15;
                    invertSprings.splice(i, 1);
                    console.log('üåÄ –ü–û–†–¢–ê–õ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù! –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç –≤ —Ä–µ–∂–∏–º:', player.isInverted);
                }
            }

            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –º–æ–Ω—Å—Ç—Ä–∞–º–∏ - –û–¢–ö–õ–Æ–ß–ï–ù–û
            // –í—Ä–∞–≥–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–≥—Ä—ã

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã (—Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º –¢–û–õ–¨–ö–û –≤–≤–µ—Ä—Ö)
            if (player.y < cameraY + canvas.height * 0.3) {
                cameraY = player.y - canvas.height * 0.3;
            }
            // –ö–∞–º–µ—Ä–∞ –ù–ï —Å–ª–µ–¥—É–µ—Ç –≤–Ω–∏–∑ - —á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ –º–æ–≥ —É–ø–∞—Å—Ç—å –∏ —É–º–µ—Ä–µ—Ç—å

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ (–æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –≤—ã—Å–æ—Ç–µ –ø–æ–¥—ä–µ–º–∞)
            const newScore = Math.max(0, Math.floor((0 - player.y) / 10));
            if (newScore > score) {
                score = newScore;
                scoreTextEl.textContent = score;
                
                // –°–û–ó–î–ê–ù–ò–ï –§–û–ù–ê–†–Ø - –°–¢–†–û–ì–û –Ω–∞ 1950 —Å–æ–∑–¥–∞—ë–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è 2000 –æ—á–∫–æ–≤!
                if (score >= 1950 && !lanternCreated) {
                    // Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –¥–ª—è 2000 –æ—á–∫–æ–≤: y = -2000 * 10 = -20000
                    const target2000Y = -20000;
                    
                    // –£–î–ê–õ–Ø–ï–ú –≤—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Ä—è–¥–æ–º (¬±100px) —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π
                    platforms = platforms.filter(p => Math.abs(p.y - target2000Y) > 100);
                    
                    // –°–û–ó–î–ê–Å–ú –°–ü–ï–¶–ò–ê–õ–¨–ù–£–Æ –ü–õ–ê–¢–§–û–†–ú–£ –ù–ê 2000 –û–ß–ö–û–í
                    const lanternPlatform = {
                        x: canvas.width / 2 - PLATFORM_WIDTH / 2,
                        y: target2000Y,
                        width: PLATFORM_WIDTH,
                        height: PLATFORM_HEIGHT,
                        type: 'normal',
                        moveDirection: 1,
                        moveSpeed: 0, // –ù–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è
                        spriteIndex: 0
                    };
                    platforms.push(lanternPlatform);
                    
                    // –°—Ç–∞–≤–∏–º —Ñ–æ–Ω–∞—Ä—å –Ω–∞ —ç—Ç—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
                    createLantern(lanternPlatform.x, lanternPlatform.y, lanternPlatform.width);
                    lanternCreated = true;
                    lanternY = target2000Y;
                    console.log('üî¶ –ü–õ–ê–¢–§–û–†–ú–ê –ò –§–û–ù–ê–†–¨ –°–û–ó–î–ê–ù–´ –ù–ê 2000 –û–ß–ö–ê–•! Y:', target2000Y);
                }
                
                // –°–û–ó–î–ê–ù–ò–ï –ü–û–†–¢–ê–õ–ê #1 (–ü–ï–†–ï–í–û–†–û–¢) - –Ω–∞ 3450 —Å–æ–∑–¥–∞—ë–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è 3500 –æ—á–∫–æ–≤!
                if (score >= 3450 && !invertSpring1Created) {
                    // Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –¥–ª—è 3500 –æ—á–∫–æ–≤: y = -3500 * 10 = -35000
                    const target3500Y = -35000;
                    
                    // –£–î–ê–õ–Ø–ï–ú –≤—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Ä—è–¥–æ–º (¬±100px) —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π
                    platforms = platforms.filter(p => Math.abs(p.y - target3500Y) > 100);
                    
                    // –°–û–ó–î–ê–Å–ú –°–ü–ï–¶–ò–ê–õ–¨–ù–£–Æ –ü–õ–ê–¢–§–û–†–ú–£ –ù–ê 3500 –û–ß–ö–û–í
                    const spring1Platform = {
                        x: canvas.width / 2 - PLATFORM_WIDTH / 2,
                        y: target3500Y,
                        width: PLATFORM_WIDTH,
                        height: PLATFORM_HEIGHT,
                        type: 'normal',
                        moveDirection: 1,
                        moveSpeed: 0, // –ù–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è
                        isSpring1Platform: true // –ó–∞—â–∏—Ç–∞ –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è
                    };
                    platforms.push(spring1Platform);
                    
                    // –°—Ç–∞–≤–∏–º –ø–æ—Ä—Ç–∞–ª –Ω–∞ —ç—Ç—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—É (–°–í–ï–†–•–£)
                    createInvertSpring(spring1Platform.x, spring1Platform.y, spring1Platform.width, spring1Platform.height, true);
                    invertSpring1Created = true;
                    console.log('üåÄ –ü–û–†–¢–ê–õ #1 (–ü–ï–†–ï–í–û–†–û–¢) –°–û–ó–î–ê–ù –ù–ê 3500 –û–ß–ö–ê–•! Y:', target3500Y);
                }
                
                // –°–û–ó–î–ê–ù–ò–ï –ü–û–†–¢–ê–õ–ê #2 (–í–û–ó–í–†–ê–¢) - –Ω–∞ 3950 —Å–æ–∑–¥–∞—ë–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è 4000 –æ—á–∫–æ–≤!
                if (score >= 3950 && !invertSpring2Created) {
                    // Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –¥–ª—è 4000 –æ—á–∫–æ–≤: y = -4000 * 10 = -40000
                    const target4000Y = -40000;
                    
                    // –£–î–ê–õ–Ø–ï–ú –≤—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Ä—è–¥–æ–º (¬±100px) —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π
                    platforms = platforms.filter(p => Math.abs(p.y - target4000Y) > 100);
                    
                    // –°–û–ó–î–ê–Å–ú –°–ü–ï–¶–ò–ê–õ–¨–ù–£–Æ –ü–õ–ê–¢–§–û–†–ú–£ –ù–ê 4000 –û–ß–ö–û–í
                    const spring2Platform = {
                        x: canvas.width / 2 - PLATFORM_WIDTH / 2,
                        y: target4000Y,
                        width: PLATFORM_WIDTH,
                        height: PLATFORM_HEIGHT,
                        type: 'normal',
                        moveDirection: 1,
                        moveSpeed: 0, // –ù–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è
                        isSpring2Platform: true // –ó–∞—â–∏—Ç–∞ –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è
                    };
                    platforms.push(spring2Platform);
                    
                    // –°—Ç–∞–≤–∏–º –ø–æ—Ä—Ç–∞–ª –Ω–∞ —ç—Ç—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—É (–°–ù–ò–ó–£, –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞ –≤ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ)
                    createInvertSpring(spring2Platform.x, spring2Platform.y, spring2Platform.width, spring2Platform.height, false);
                    invertSpring2Created = true;
                    console.log('üåÄ –ü–û–†–¢–ê–õ #2 (–í–û–ó–í–†–ê–¢) –°–û–ó–î–ê–ù –ù–ê 4000 –û–ß–ö–ê–•! Y:', target4000Y);
                }
            }

            // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—É –∏–≥—Ä–æ–∫–∞ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            // –ß–µ–º –≤—ã—à–µ, —Ç–µ–º –º–µ–Ω—å—à–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º –∏ —Å–ª–æ–∂–Ω–µ–µ
            // player.y —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥—ä–µ–º–µ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è), –ø–æ—ç—Ç–æ–º—É –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
            const playerHeight = Math.max(0, -player.y); // –í—ã—Å–æ—Ç–∞ –æ—Ç —Å—Ç–∞—Ä—Ç–∞
            const difficultyLevel = Math.floor(playerHeight / 1000); // –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥—ã–µ 1000 –ø–∏–∫—Å–µ–ª–µ–π
            
            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å –≤—ã—Å–æ—Ç–æ–π (–±–∞–∑–æ–≤–æ–µ 35, –º–∏–Ω–∏–º—É–º 18)
            let platformsToGenerate = Math.max(18, 35 - difficultyLevel);
            // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –≤—ã—Å–æ—Ç–æ–π (–±–∞–∑–æ–≤–æ–µ 70, –º–∞–∫—Å–∏–º—É–º 95)
            let currentSpacing = Math.min(95, 70 + difficultyLevel * 3);
            
            // –í –ò–ù–í–ï–†–¢–ò–†–û–í–ê–ù–ù–û–ú –†–ï–ñ–ò–ú–ï —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–∫–∞, –∞ –Ω–µ –æ—á–∫–∏!)
            if (player.isInverted) {
                platformsToGenerate = Math.max(7, Math.floor(platformsToGenerate * 0.4)); // 60% –º–µ–Ω—å—à–µ, –º–∏–Ω–∏–º—É–º 7
                currentSpacing = Math.min(128, Math.floor(currentSpacing * 1.35)); // 35% –±–æ–ª—å—à–µ, –º–∞–∫—Å–∏–º—É–º 128
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º –≤—ã—à–µ –∏–≥—Ä–æ–∫–∞
            if (platforms.length > 0) {
                const highestPlatform = Math.min(...platforms.map(p => p.y));
                if (highestPlatform > player.y - 1000) {
                    // –°–Ω–∞—á–∞–ª–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                    for (let i = 1; i <= platformsToGenerate; i++) {
                        createPlatform(highestPlatform - i * currentSpacing);
                    }
                    
                }
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –±–æ–Ω—É—Å–æ–≤ –≤—ã—à–µ –∏–≥—Ä–æ–∫–∞ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º)
            const allY = [player.y - 500];
            platforms.forEach(p => allY.push(p.y));
            // if (monsters.length > 0) allY.push(...monsters.map(m => m.y)); // –ú–æ–Ω—Å—Ç—Ä—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã
            if (jetpacks.length > 0) allY.push(...jetpacks.map(j => j.y));
            
            const highestY = Math.min(...allY);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç (—Ä–∞–Ω–µ—Ü –∞–∫—Ç–∏–≤–µ–Ω –∏–ª–∏ –Ω–µ–¥–∞–≤–Ω–æ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è)
            const currentTime = Date.now();
            let hasActiveJetpack = false;
            if (player.hasJetpack && player.jetpackStartTime > 0) {
                const elapsed = currentTime - player.jetpackStartTime;
                hasActiveJetpack = (elapsed < player.jetpackDuration);
            }
            const hasImmunity = hasActiveJetpack || (player.immunityEndTime > 0 && currentTime < player.immunityEndTime);
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–º–º—É–Ω–∏—Ç–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–æ–Ω—Å—Ç—Ä–æ–≤ –∏ –±—É—Å—Ç–µ—Ä—ã –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
            const minGenerationY = hasImmunity ? player.y - 800 : player.y - 1500;
            
            if (highestY > minGenerationY) {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–æ–Ω—Å—Ç—Ä–æ–≤ –∏ –±—É—Å—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º
                // –ß–µ–º –≤—ã—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –º–æ–Ω—Å—Ç—Ä–æ–≤ (–∫–∞–∂–¥—ã–µ 3-4 –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã - –±–æ–ª—å—à–µ –º–æ–Ω—Å—Ç—Ä–æ–≤)
                const monsterInterval = Math.max(3, 5 - Math.floor(difficultyLevel / 2));
                // –†–∞–Ω—Ü—ã –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 –ø–ª–∞—Ç—Ñ–æ—Ä–º
                const jetpackInterval = 10;
                
                let monsterCounter = 0;
                let jetpackCounter = 0;
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞ –±–æ–ª—å—à–µ–π –≤—ã—Å–æ—Ç–µ, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø–∞–¥–∞–ª–∏
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–º–º—É–Ω–∏—Ç–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
                const startY = hasImmunity ? player.y - 800 : highestY;
                
                for (let i = 1; i <= platformsToGenerate + 5; i++) {
                    const y = startY - i * currentSpacing;
                    
                    // –ú–æ–Ω—Å—Ç—Ä—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞
                    
                    // –†–∞–Ω–µ—Ü –∫–∞–∂–¥—ã–µ 10 –ø–ª–∞—Ç—Ñ–æ—Ä–º (—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ) - –¢–û–õ–¨–ö–û –î–û 800 –û–ß–ö–û–í!
                    if (score < 800 && currentTime >= player.jetpacksHiddenUntil) {
                        jetpackCounter++;
                        if (jetpackCounter >= jetpackInterval) {
                            createJetpack(y);
                            jetpackCounter = 0;
                        }
                    }
                    // –ü—Ä—É–∂–∏–Ω—ã —Å–∫—Ä—ã—Ç—ã
                }
            }

            // –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç–∫—Ä–∞–Ω–∞ (–≤–Ω–∏–∑—É)
            // –ù–û —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ–Ω–∞—Ä–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É (Y = -20000) –∏ –ø–æ—Ä—Ç–∞–ª–æ–≤—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            const lanternPlatformY = -20000;
            platforms = platforms.filter(p => {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (—Ñ–æ–Ω–∞—Ä—å, –ø–æ—Ä—Ç–∞–ª—ã)
                if (p.isSpring1Platform || p.isSpring2Platform) {
                    return true; // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—Ç–∞–ª–æ–≤—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                }
                if (lanternCreated && Math.abs(p.y - lanternPlatformY) < 10) {
                    return true; // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ–Ω–∞—Ä–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
                }
                return p.y < cameraY + canvas.height + 1000; // –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
            });
            // monsters = monsters.filter(m => m.y < cameraY + canvas.height + 1000); // –ú–æ–Ω—Å—Ç—Ä—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã
            jetpacks = jetpacks.filter(j => j.y < cameraY + canvas.height + 1000);
            springs = springs.filter(s => s.y < cameraY + canvas.height + 1000);
            lanterns = lanterns.filter(l => l.y < cameraY + canvas.height + 1000);
            invertSprings = invertSprings.filter(s => s.y < cameraY + canvas.height + 1000);

            // –ü—Ä–æ–∏–≥—Ä—ã—à (–ø–∞–¥–µ–Ω–∏–µ –≤–Ω–∏–∑ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞)
            const playerScreenY = player.y - cameraY;
            
            // –ò–≥—Ä–æ–∫ —É–º–∏—Ä–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –†–ï–ê–õ–¨–ù–û –≤—ã–ª–µ—Ç–µ–ª –∑–∞ –Ω–∏–∂–Ω–∏–π –∫—Ä–∞–π —ç–∫—Ä–∞–Ω–∞
            // –≠—Ç–æ –¥–∞–µ—Ç —à–∞–Ω—Å –ø–æ–ø–∞—Å—Ç—å –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, —É–ø—Ä–∞–≤–ª—è—è –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ –≤–æ –≤—Ä–µ–º—è –ø–∞–¥–µ–Ω–∏—è
            if (playerScreenY > canvas.height + 50) {
                gameOver();
                return;
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        function draw() {
            // –û—á–∏—Å—Ç–∫–∞ —ç–∫—Ä–∞–Ω–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –§–æ–Ω (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç –∫–∞–∫ fallback) - —Å—Ç–∞—Ç–∏—á–Ω—ã–π, –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è
            if (backgroundLoaded && backgroundImage.complete) {
                // –°—Ç–∞—Ç–∏—á–Ω—ã–π —Ñ–æ–Ω - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏, –∑–∞–ø–æ–ª–Ω—è–µ–º –≤–µ—Å—å —ç–∫—Ä–∞–Ω (cover)
                const bgWidth = backgroundImage.width;
                const bgHeight = backgroundImage.height;
                const canvasAspect = canvas.width / canvas.height;
                const bgAspect = bgWidth / bgHeight;
                
                let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                
                if (bgAspect > canvasAspect) {
                    // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∏—Ä–µ - –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ
                    drawHeight = canvas.height;
                    drawWidth = bgWidth * (canvas.height / bgHeight);
                    offsetX = (canvas.width - drawWidth) / 2;
                } else {
                    // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã—à–µ - –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ
                    drawWidth = canvas.width;
                    drawHeight = bgHeight * (canvas.width / bgWidth);
                    offsetY = (canvas.height - drawHeight) / 2;
                }
                
                ctx.drawImage(backgroundImage, offsetX, offsetY, drawWidth, drawHeight);
            } else {
                // Fallback: –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(0.5, '#98D8E8');
                gradient.addColorStop(1, '#B0E0E6');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // –û–±–ª–∞–∫–∞ (–¥–µ–∫–æ—Ä–∞—Ü–∏—è) - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ–Ω–∞
                drawClouds();
            }

            // –ò–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å
            if (gameState === 'playing') {
                // CSS —Ñ–æ–Ω–∞—Ä—å
                const cssLanternEl = document.getElementById('cssLantern');
                if (lanterns.length > 0) {
                    const lantern = lanterns[0];
                    const screenY = lantern.y - cameraY;
                    if (screenY > -100 && screenY < canvas.height + 100) {
                        cssLanternEl.style.display = 'block';
                        cssLanternEl.style.left = (lantern.x + lantern.size / 2) + 'px';
                        cssLanternEl.style.top = (screenY + lantern.size / 2 - 20) + 'px';
                    } else {
                        cssLanternEl.style.display = 'none';
                    }
                } else {
                    cssLanternEl.style.display = 'none';
                }
                
                // –†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞–Ω—Ü—ã (—Ä–∏—Å—É–µ–º –ü–ï–†–ï–î –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏ –∏ –º–æ–Ω—Å—Ç—Ä–∞–º–∏, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ª–µ–∑–∞–ª–∏ –Ω–∞ –Ω–∏—Ö)
                for (let jetpack of jetpacks) {
                    const screenY = jetpack.y - cameraY;
                    if (screenY > -50 && screenY < canvas.height + 50) {
                        if (jetpackImageLoaded && jetpackImage.complete) {
                            // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–Ω—Ü–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
                            const aspectRatio = jetpackImage.height / jetpackImage.width;
                            const drawWidth = jetpack.size;
                            const drawHeight = jetpack.size * aspectRatio;
                            
                            // –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è/—Å–∏—è–Ω–∏—è
                            const glowIntensity = 0.6 + 0.4 * Math.sin(Date.now() / 200);
                            
                            // –†–∏—Å—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–µ–≤ —Å–≤–µ—á–µ–Ω–∏—è
                            for (let i = 3; i > 0; i--) {
                                ctx.globalAlpha = glowIntensity * (i / 3) * 0.3;
                                ctx.shadowBlur = 15 + i * 5;
                                ctx.shadowColor = 'rgba(255, 215, 0, 0.8)';
                                ctx.drawImage(
                                    jetpackImage, 
                                    jetpack.x - i * 2, 
                                    screenY - i * 2, 
                                    drawWidth + i * 4, 
                                    drawHeight + i * 4
                                );
                            }
                            
                            // –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            ctx.globalAlpha = 1.0;
                            ctx.shadowBlur = 0;
                            ctx.drawImage(jetpackImage, jetpack.x, screenY, drawWidth, drawHeight);
                        } else {
                            // Fallback: –ø—Ä–æ—Å—Ç–æ–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –ø–æ–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
                            ctx.fillStyle = '#FF4444';
                            ctx.fillRect(jetpack.x, screenY, jetpack.size, jetpack.size * 1.2);
                            ctx.fillStyle = '#FF8800';
                            ctx.fillRect(jetpack.x + 5, screenY + 5, jetpack.size - 10, jetpack.size * 1.2 - 10);
                        }
                    }
                }

                // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
                for (let platform of platforms) {
                    const screenY = platform.y - cameraY;
                    if (screenY > -100 && screenY < canvas.height + 100) {
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º
                        if (platform.type === 'fading' && platform.opacity !== undefined) {
                            ctx.globalAlpha = platform.opacity;
                        } else if (platform.type === 'oneTouch') {
                            // –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã - –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ
                            ctx.globalAlpha = 0.5;
                        } else {
                            ctx.globalAlpha = 1.0;
                        }
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç/—Å–ø—Ä–∞–π—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                        let platformColor = '#4CAF50'; // –ó–µ–ª–µ–Ω—ã–π - –æ–±—ã—á–Ω–∞—è
                        let useSprite = false;
                        let sprite = platformImage;
                        
                        if (platform.type === 'moving') {
                            platformColor = '#FF6B6B'; // –ö—Ä–∞—Å–Ω—ã–π - –¥–≤–∏–∂—É—â–∞—è—Å—è
                            useSprite = movingPlatformImageLoaded && movingPlatformImage.complete && movingPlatformImage.width > 0;
                            sprite = movingPlatformImage;
                        } else if (platform.type === 'oneTouch') {
                            platformColor = '#FF4444'; // –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π - –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è
                            useSprite = platformImageLoaded && platformImage.complete && platformImage.width > 0;
                        } else if (platform.type === 'fading') {
                            platformColor = '#8888FF'; // –°–∏–Ω–∏–π - –∏—Å—á–µ–∑–∞—é—â–∞—è
                            useSprite = platformImageLoaded && platformImage.complete && platformImage.width > 0;
                        } else {
                            useSprite = platformImageLoaded && platformImage.complete && platformImage.width > 0 && platformImage.height > 0;
                        }
                        
                        if (useSprite && sprite) {
                            const spriteWidth = sprite.width;
                            const spriteHeight = sprite.height;
                            
                            // –¢–∞–π–ª–∏–Ω–≥ —Ç–µ–∫—Å—Ç—É—Ä—ã –ø–æ —à–∏—Ä–∏–Ω–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                            const tiles = Math.ceil(platform.width / spriteWidth);
                            for (let i = 0; i < tiles; i++) {
                                const x = platform.x + (i * spriteWidth);
                                const drawWidth = Math.min(spriteWidth, platform.x + platform.width - x);
                                ctx.drawImage(
                                    sprite,
                                    0, 0, spriteWidth, spriteHeight, // –∏—Å—Ç–æ—á–Ω–∏–∫ (–ø–æ–ª–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
                                    x, screenY, drawWidth, platform.height // –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
                                );
                            }
                        } else {
                            // Fallback: —Ü–≤–µ—Ç–Ω–æ–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –ø–æ–∫–∞ —Å–ø—Ä–∞–π—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
                            ctx.fillStyle = platformColor;
                            ctx.fillRect(platform.x, screenY, platform.width, platform.height);
                            ctx.strokeStyle = '#2E7D32';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(platform.x, screenY, platform.width, platform.height);
                            
                            // –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤
                            if (platform.type === 'oneTouch') {
                                // –ö—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–π
                                ctx.strokeStyle = '#FFFFFF';
                                ctx.lineWidth = 3;
                                ctx.beginPath();
                                ctx.moveTo(platform.x + 10, screenY + 10);
                                ctx.lineTo(platform.x + platform.width - 10, screenY + platform.height - 10);
                                ctx.moveTo(platform.x + platform.width - 10, screenY + 10);
                                ctx.lineTo(platform.x + 10, screenY + platform.height - 10);
                                ctx.stroke();
                            }
                        }
                        
                        ctx.globalAlpha = 1.0; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                    }
                }

                // –ü—Ä—É–∂–∏–Ω—ã —Å–∫—Ä—ã—Ç—ã (–Ω–µ —Ä–∏—Å—É–µ–º)
                
                // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—â–∏–µ –ø–æ—Ä—Ç–∞–ª—ã (–∫—Ä–∞—Å–∏–≤–∞—è –≤–µ—Ä—Å–∏—è –∏–∑ —Ç–µ—Å—Ç–∞!)
                for (let spring of invertSprings) {
                    const screenY = spring.y - cameraY;
                    if (screenY > -100 && screenY < canvas.height + 100) {
                        const centerX = spring.x + spring.size / 2;
                        const centerY = screenY + spring.size / 2;
                        const radius = spring.size / 2;
                        
                        ctx.save();
                        
                        // –í–∏—Ö—Ä–µ–≤—ã–µ –∫–æ–ª—å—Ü–∞ –ø–æ—Ä—Ç–∞–ª–∞
                        const color1 = spring.invertTo ? '#ff4444' : '#4444ff'; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞, —Å–∏–Ω–∏–π –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
                        const color2 = spring.invertTo ? '#ff8844' : '#8844ff';
                        
                        const gradient = ctx.createRadialGradient(centerX, centerY, radius * 0.2, centerX, centerY, radius * 0.9);
                        gradient.addColorStop(0, color1);
                        gradient.addColorStop(0.5, color2);
                        gradient.addColorStop(1, 'rgba(255, 255, 255, 0.2)');
                        
                        // –†–∏—Å—É–µ–º –≤–∏—Ö—Ä–µ–≤—ã–µ –∫–æ–ª—å—Ü–∞
                        for (let i = 0; i < 3; i++) {
                            ctx.strokeStyle = gradient;
                            ctx.lineWidth = 6;
                            ctx.lineCap = 'round';
                            ctx.beginPath();
                            ctx.arc(centerX, centerY, radius * 0.4 + i * (radius * 0.2), i * 0.5, Math.PI * 2 - i * 0.5);
                            ctx.stroke();
                        }
                        
                        // –Ø—Ä–∫–∏–π —Ü–µ–Ω—Ç—Ä –ø–æ—Ä—Ç–∞–ª–∞
                        const centerGradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius * 0.3);
                        centerGradient.addColorStop(0, '#ffffff');
                        centerGradient.addColorStop(0.5, color1);
                        centerGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                        
                        ctx.fillStyle = centerGradient;
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius * 0.3, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç
                        const pulse = 0.8 + 0.2 * Math.sin(Date.now() / 200);
                        ctx.globalAlpha = pulse;
                        ctx.fillStyle = '#fff';
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius * 0.15, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.restore();
                    }
                }

                // –ú–æ–Ω—Å—Ç—Ä—ã - –û–¢–ö–õ–Æ–ß–ï–ù–´
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–æ–Ω—Å—Ç—Ä–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞

                // –ò–≥—Ä–æ–∫ (–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ)
                const playerScreenY = player.y - cameraY;
                
                // –ì–æ–ª—É–±–æ–µ —Å–∏—è–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –≥–µ—Ä–æ—è –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–∞–Ω—Ü–µ
                const drawTime = Date.now();
                let hasActiveJetpack = false;
                if (player.hasJetpack && player.jetpackStartTime > 0) {
                    const elapsed = drawTime - player.jetpackStartTime;
                    hasActiveJetpack = (elapsed < player.jetpackDuration);
                }
                const hasImmunity = hasActiveJetpack || (player.immunityEndTime > 0 && drawTime < player.immunityEndTime);
                
                if (hasActiveJetpack || hasImmunity) {
                    // –≠—Ñ—Ñ–µ–∫—Ç —è—Ä–∫–æ–≥–æ –≥–æ–ª—É–±–æ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è (–∫—Ä—É–≥–ª–æ–µ)
                    const glowIntensity = 0.8 + 0.2 * Math.sin(Date.now() / 120);
                    
                    // –†–∏—Å—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–µ–≤ —Å–≤–µ—á–µ–Ω–∏—è (–∫—Ä—É–≥) - –º–µ–Ω—å—à–∏–π —Ä–∞–¥–∏—É—Å –∏ –±–æ–ª–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ
                    for (let i = 4; i > 0; i--) {
                        ctx.globalAlpha = glowIntensity * (i / 4) * 0.3; // –ë–æ–ª–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ
                        ctx.shadowBlur = 15 + i * 5;
                        ctx.shadowColor = 'rgba(135, 206, 250, 0.8)'; // –ë–æ–ª–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
                        ctx.beginPath();
                        ctx.arc(
                            player.x + player.width / 2, 
                            playerScreenY + player.height / 2, 
                            (player.width / 2) + i * 5, 
                            0, 
                            Math.PI * 2
                        );
                        ctx.fillStyle = `rgba(135, 206, 250, ${0.2 + i * 0.05})`;
                        ctx.fill();
                    }
                    
                    ctx.globalAlpha = 1.0;
                    ctx.shadowBlur = 0;
                }
                
                // –í—ã–±–∏—Ä–∞–µ–º —Å–ø—Ä–∞–π—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–æ–º–µ–Ω—è–ª–∏ –º–µ—Å—Ç–∞–º–∏)
                const currentPlayerImage = player.facingRight ? playerImageLeft : playerImageRight;
                const currentPlayerImageLoaded = player.facingRight ? playerImageLeftLoaded : playerImageRightLoaded;
                
                if (currentPlayerImageLoaded && currentPlayerImage.complete) {
                    // –ú–µ—Ä—Ü–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–∞–Ω—Ü–µ
                    if (hasActiveJetpack) {
                        const flicker = 0.6 + 0.4 * Math.sin(Date.now() / 100); // –ë—ã—Å—Ç—Ä–æ–µ –º–µ—Ä—Ü–∞–Ω–∏–µ
                        ctx.globalAlpha = flicker;
                    } else {
                        ctx.globalAlpha = 1.0;
                    }
                    
                    // –ü–ï–†–ï–í–û–†–û–¢ –ü–ï–†–°–û–ù–ê–ñ–ê (–∞–Ω–∏–º–∞—Ü–∏—è –∏–ª–∏ —Å—Ç–∞—Ç–∏—á–Ω—ã–π)
                    if (player.isFlipping) {
                        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞
                        const elapsed = Date.now() - player.flipStartTime;
                        let rotation = 0;
                        if (elapsed < FLIP_DURATION) {
                            const progress = elapsed / FLIP_DURATION;
                            rotation = player.isInverted ? (progress * 180) : (180 - progress * 180);
                        } else {
                            player.isFlipping = false;
                            rotation = player.isInverted ? 180 : 0;
                        }
                        ctx.save();
                        ctx.translate(player.x + player.width / 2, playerScreenY + player.height / 2);
                        ctx.rotate(rotation * Math.PI / 180);
                        ctx.drawImage(currentPlayerImage, -player.width / 2, -player.height / 2, player.width, player.height);
                        ctx.restore();
                    } else {
                        // –°—Ç–∞—Ç–∏—á–Ω—ã–π –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç (–µ—Å–ª–∏ —É–∂–µ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç)
                        ctx.save();
                        ctx.translate(player.x + player.width / 2, playerScreenY + player.height / 2);
                        ctx.rotate(player.isInverted ? Math.PI : 0); // 180 –≥—Ä–∞–¥—É—Å–æ–≤ –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç
                        ctx.drawImage(currentPlayerImage, -player.width / 2, -player.height / 2, player.width, player.height);
                        ctx.restore();
                    }
                    
                    ctx.globalAlpha = 1.0; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                } else {
                    // Fallback: –ø—Ä–æ—Å—Ç–æ–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –ø–æ–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
                    ctx.fillStyle = '#4169E1'; // –ì–æ–ª—É–±–æ–π –≤–º–µ—Å—Ç–æ –∑–æ–ª–æ—Ç–æ–≥–æ
                    ctx.fillRect(player.x, playerScreenY, player.width, player.height);
                    // –õ–∏—Ü–æ –∏–≥—Ä–æ–∫–∞
                    ctx.fillStyle = '#000';
                    // –ì–ª–∞–∑–∞
                    ctx.fillRect(player.x + 10, playerScreenY + 12, 6, 6);
                    ctx.fillRect(player.x + 24, playerScreenY + 12, 6, 6);
                    // –†–æ—Ç
                    ctx.beginPath();
                    ctx.arc(player.x + player.width / 2, playerScreenY + 30, 8, 0, Math.PI);
                    ctx.stroke();
                }

                // –†–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞–Ω–µ—Ü - –°–¢–†–û–ì–ê–Ø –ü–†–û–í–ï–†–ö–ê –î–õ–Ø –ê–ù–ò–ú–ê–¶–ò–ò
                const currentTime = Date.now();
                
                // –°–¢–†–û–ì–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –∏ –æ—Ç–∫–ª—é—á–∞–µ–º —Ä–∞–Ω–µ—Ü –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                
                // ===== –≠–§–§–ï–ö–¢ –¢–ï–ú–ù–û–¢–´ =====
                // –¢–µ–º–Ω–æ—Ç–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ü–û–°–õ–ï –ø–æ–¥–±–æ—Ä–∞ —Ñ–æ–Ω–∞—Ä—è –∏ –¥–ª–∏—Ç—Å—è –æ—Ç 2000 –¥–æ 3000 –æ—á–∫–æ–≤
                // –ü–æ—Å–ª–µ 2500 –æ—á–∫–æ–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–≤–µ—Ç–ª–µ—Ç—å, –Ω–∞ 3000 –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–≤–µ—Ç–ª–æ
                if (lanternY !== null && player.hasLantern) {
                    const darknessStartScreenY = lanternY - cameraY;
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞—Ç—É—Ö–∞–Ω–∏—è —Ç–µ–º–Ω–æ—Ç—ã (–¥–ª—è —Ä–∞—Å—Å–≤–µ—Ç–∞)
                    let darknessMultiplier = 1.0;
                    if (score >= 2500 && score < 3000) {
                        // –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—Ç–ª–µ–Ω–∏–µ –æ—Ç 2500 –¥–æ 3000 –æ—á–∫–æ–≤
                        darknessMultiplier = 1.0 - ((score - 2500) / 500); // –û—Ç 1.0 –¥–æ 0.0
                    } else if (score >= 3000) {
                        // –ù–∞ 3000+ –æ—á–∫–æ–≤ - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–≤–µ—Ç–ª–æ, —Ñ–æ–Ω–∞—Ä—å –∏—Å—á–µ–∑–∞–µ—Ç
                        player.hasLantern = false;
                        player.lightRadius = 0;
                        darknessMultiplier = 0;
                    }
                    
                    // –ï—Å–ª–∏ —Ñ–æ–Ω–∞—Ä—å –≤—ã—à–µ —ç–∫—Ä–∞–Ω–∞ - —Ç–µ–º–Ω–æ—Ç–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                    if (darknessStartScreenY < 0 && darknessMultiplier > 0) {
                        const distanceAbove = cameraY - lanternY;
                        const darknessProgress = Math.min(1, distanceAbove / DARKNESS_HEIGHT);
                        const darknessAlpha = darknessProgress * 0.95 * darknessMultiplier;
                        
                        // –ù–û–í–´–ô –ü–û–î–•–û–î: –†–∏—Å—É–µ–º —Ç–µ–º–Ω–æ—Ç—É –≤–µ–∑–¥–µ, –ø–æ—Ç–æ–º –í–´–†–ï–ó–ê–ï–ú –∫—Ä—É–≥ –∏—Å–ø–æ–ª—å–∑—É—è destination-out
                        if (player.hasLantern && player.lightRadius > 0) {
                            const playerCenterX = player.x + player.width / 2;
                            const playerCenterY = playerScreenY + player.height / 2;
                            
                            // –®–ê–ì 1: –†–∏—Å—É–µ–º —Ç–µ–º–Ω–æ—Ç—É –≤–µ–∑–¥–µ
                            ctx.fillStyle = `rgba(0, 0, 0, ${darknessAlpha})`;
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            
                            // –®–ê–ì 2: –í–´–†–ï–ó–ê–ï–ú –∫—Ä—É–≥ –∏–∑ —Ç–µ–º–Ω–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—è destination-out
                            ctx.save();
                            ctx.globalCompositeOperation = 'destination-out';
                            ctx.beginPath();
                            ctx.arc(playerCenterX, playerCenterY, player.lightRadius, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.restore();
                            
                            // –®–ê–ì 3: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—É—é –∫–æ–º–ø–æ–∑–∏—Ç–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
                            ctx.globalCompositeOperation = 'source-over';
                        } else {
                            // –ë–µ–∑ —Ñ–æ–Ω–∞—Ä—è - –æ–±—ã—á–Ω–∞—è —Ç–µ–º–Ω–æ—Ç–∞
                            ctx.fillStyle = `rgba(0, 0, 0, ${darknessAlpha})`;
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                        }
                    } else if (darknessMultiplier > 0) {
                        // –§–æ–Ω–∞—Ä—å –≤–∏–¥–µ–Ω - –≥—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –≤–µ—Ä—Ö–∞ –¥–æ —Ñ–æ–Ω–∞—Ä—è
                        const gradient = ctx.createLinearGradient(0, 0, 0, darknessStartScreenY);
                        const topWorldY = cameraY;
                        const distanceAboveTop = lanternY - topWorldY;
                        const topDarknessProgress = Math.min(1, distanceAboveTop / DARKNESS_HEIGHT);
                        const topDarknessAlpha = topDarknessProgress * 0.95 * darknessMultiplier;
                        
                        gradient.addColorStop(0, `rgba(0, 0, 0, ${topDarknessAlpha})`);
                        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                        
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, darknessStartScreenY);
                    }
                }
                
                // –ü–ï–†–ï–†–ò–°–û–í–´–í–ê–ï–ú –≠–õ–ï–ú–ï–ù–¢–´ –í–ù–£–¢–†–ò –ö–†–£–ì–ê –ü–û–°–õ–ï –¢–ï–ú–ù–û–¢–´ (—á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ —Å–≤–µ—Ç–ª—ã–º–∏)
                if (lanternY !== null && player.hasLantern && player.lightRadius > 0) {
                    const playerCenterX = player.x + player.width / 2;
                    const playerCenterY = playerScreenY + player.height / 2;
                    
                    ctx.save();
                    // Clip —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±–ª–∞—Å—Ç–∏ –≤–Ω—É—Ç—Ä–∏ –∫—Ä—É–≥–∞
                    ctx.beginPath();
                    ctx.arc(playerCenterX, playerCenterY, player.lightRadius, 0, Math.PI * 2);
                    ctx.clip();
                    
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ñ–æ–Ω –≤–Ω—É—Ç—Ä–∏ –∫—Ä—É–≥–∞
                    if (backgroundLoaded && backgroundImage.complete) {
                        const bgWidth = backgroundImage.width;
                        const bgHeight = backgroundImage.height;
                        const canvasAspect = canvas.width / canvas.height;
                        const bgAspect = bgWidth / bgHeight;
                        
                        let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                        
                        if (bgAspect > canvasAspect) {
                            drawHeight = canvas.height;
                            drawWidth = bgWidth * (canvas.height / bgHeight);
                            offsetX = (canvas.width - drawWidth) / 2;
                        } else {
                            drawWidth = canvas.width;
                            drawHeight = bgHeight * (canvas.width / bgWidth);
                            offsetY = (canvas.height - drawHeight) / 2;
                        }
                        
                        ctx.drawImage(backgroundImage, offsetX, offsetY, drawWidth, drawHeight);
                    }
                    
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤–Ω—É—Ç—Ä–∏ –∫—Ä—É–≥–∞
                    for (let platform of platforms) {
                        const platformScreenY = platform.y - cameraY;
                        if (platformScreenY > -100 && platformScreenY < canvas.height + 100) {
                            if (platform.type === 'fading' && platform.opacity !== undefined) {
                                ctx.globalAlpha = platform.opacity;
                            } else if (platform.type === 'oneTouch') {
                                ctx.globalAlpha = 0.5;
                            } else {
                                ctx.globalAlpha = 1.0;
                            }
                            
                            let useSprite = false;
                            let sprite = platformImage;
                            
                            if (platform.type === 'moving') {
                                useSprite = movingPlatformImageLoaded && movingPlatformImage.complete && movingPlatformImage.width > 0;
                                sprite = movingPlatformImage;
                            } else {
                                useSprite = platformImageLoaded && platformImage.complete && platformImage.width > 0 && platformImage.height > 0;
                            }
                            
                            if (useSprite && sprite) {
                                const spriteWidth = sprite.width;
                                const spriteHeight = sprite.height;
                                const tiles = Math.ceil(platform.width / spriteWidth);
                                for (let i = 0; i < tiles; i++) {
                                    const x = platform.x + (i * spriteWidth);
                                    const drawWidth = Math.min(spriteWidth, platform.x + platform.width - x);
                                    ctx.drawImage(sprite, 0, 0, spriteWidth, spriteHeight, x, platformScreenY, drawWidth, platform.height);
                                }
                            } else {
                                ctx.fillStyle = '#4CAF50';
                                ctx.fillRect(platform.x, platformScreenY, platform.width, platform.height);
                            }
                            
                            ctx.globalAlpha = 1.0;
                        }
                    }
                    
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤–Ω—É—Ç—Ä–∏ –∫—Ä—É–≥–∞
                    const currentPlayerImage = player.facingRight ? playerImageLeft : playerImageRight;
                    const currentPlayerImageLoaded = player.facingRight ? playerImageLeftLoaded : playerImageRightLoaded;
                    
                    if (currentPlayerImageLoaded && currentPlayerImage.complete) {
                        ctx.globalAlpha = 1.0;
                        ctx.drawImage(currentPlayerImage, player.x, playerScreenY, player.width, player.height);
                    } else {
                        ctx.fillStyle = '#4169E1';
                        ctx.fillRect(player.x, playerScreenY, player.width, player.height);
                    }
                    
                    ctx.restore();
                }
            }
            
            // –ö–û–ù–¢–£–† –ö–†–£–ì–ê –°–í–ï–¢–ê - –í–°–ï–ì–î–ê –í–ò–î–ï–ù –ï–°–õ–ò –ï–°–¢–¨ –§–û–ù–ê–†–¨
            if (player.hasLantern && player.lightRadius > 0) {
                const playerScreenY2 = player.y - cameraY;
                const playerCenterX = player.x + player.width / 2;
                const playerCenterY = playerScreenY2 + player.height / 2;
                
                // –°–í–ï–¢–Ø–©–ò–ô–°–Ø –ì–û–õ–£–ë–û–ô –ö–û–ù–¢–£–†
                ctx.save();
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'rgba(135, 206, 250, 1)';
                ctx.strokeStyle = 'rgba(135, 206, 250, 0.8)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(playerCenterX, playerCenterY, player.lightRadius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
                
                // –ì–†–ê–î–ò–ï–ù–¢ –ú–ï–ñ–î–£ –î–ï–õ–ï–ù–ò–Ø–ú–ò 9-10 –ü–û –ö–†–£–ì–£
                ctx.save();
                const radius9 = (player.lightRadius / 10) * 9;
                const radius10 = player.lightRadius;
                
                // –°–æ–∑–¥–∞–µ–º —Ä–∞–¥–∏–∞–ª—å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç 9 –¥–æ 10 –¥–µ–ª–µ–Ω–∏—è
                const gradient = ctx.createRadialGradient(
                    playerCenterX, playerCenterY, radius9,
                    playerCenterX, playerCenterY, radius10
                );
                gradient.addColorStop(0, 'rgba(135, 206, 250, 0)'); // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π –Ω–∞ –¥–µ–ª–µ–Ω–∏–∏ 9
                gradient.addColorStop(1, 'rgba(135, 206, 250, 0.6)'); // –Ø—Ä–∫–∏–π –≥–æ–ª—É–±–æ–π –Ω–∞ –¥–µ–ª–µ–Ω–∏–∏ 10
                
                // –†–∏—Å—É–µ–º –±–æ–ª—å—à–æ–π –∫—Ä—É–≥ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
                ctx.beginPath();
                ctx.arc(playerCenterX, playerCenterY, radius10, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // –í—ã—Ä–µ–∑–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä—É–≥ (–¥–µ–ª–µ–Ω–∏–µ 9)
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(playerCenterX, playerCenterY, radius9, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalCompositeOperation = 'source-over';
                ctx.restore();
                
            }
            
            // –ü–ï–†–ï–í–û–†–û–¢ UI (—Å—á–µ—Ç–∞) –ø—Ä–∏ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
            scoreEl.style.transform = player.isInverted ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –æ–±–ª–∞–∫–æ–≤
        function drawClouds() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            for (let i = 0; i < 5; i++) {
                const cloudX = (i * 200 + (cameraY * 0.1) % 1000) % (canvas.width + 200) - 100;
                const cloudY = (i * 150 - cameraY * 0.05) % (canvas.height + 200);
                drawCloud(cloudX, cloudY);
            }
        }

        function drawCloud(x, y) {
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 25, y, 30, 0, Math.PI * 2);
            ctx.arc(x + 50, y, 20, 0, Math.PI * 2);
            ctx.fill();
        }

        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
        function gameOver() {
            gameState = 'gameOver';
            saveHighScore();
            finalScoreEl.textContent = score;
            gameOverEl.style.display = 'block';
            // –°–∫—Ä—ã–≤–∞–µ–º —Å—á–µ—Ç –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –∏–≥—Ä—ã
            scoreEl.style.display = 'none';
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –∏–≥—Ä—ã
            const controlsEl = document.getElementById('controls');
            if (controlsEl) controlsEl.style.display = 'none';
            // –°–∫—Ä—ã–≤–∞–µ–º CSS —Ñ–æ–Ω–∞—Ä—å
            const cssLanternEl = document.getElementById('cssLantern');
            if (cssLanternEl) cssLanternEl.style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        startBtn.addEventListener('click', initGame);
        gameOverTitle.addEventListener('click', initGame);

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ—Ä–¥–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadHighScore();

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
        gameLoop();
    </script>
</body>
</html>
